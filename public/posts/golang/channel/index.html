<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>ç¡¬æ ¸â€”â€”golangä¹‹channelã€select | Whitea's Blog</title>
<meta name=keywords content="Go"><meta name=description content="å…³äºä½œè€…å¯¹golangæ•°æ®ç»“æ„channelå’Œselectè¯­å¥åº•å±‚åŸç†çš„å­¦ä¹ ä¸æ€è€ƒ"><meta name=author content="Whitea"><link rel=canonical href=https://canonical.url/to/page><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.f49d66caae9ea0fd43f21f29e71a8d3e284517ed770f2aa86fa012953ad3c9ef.css integrity="sha256-9J1myq6eoP1D8h8p5xqNPihFF+13Dyqob6ASlTrTye8=" rel="preload stylesheet" as=style><link rel=icon href=https://whitea029.github.io/images/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://whitea029.github.io/images/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://whitea029.github.io/images/favicon-32x32.png><link rel=apple-touch-icon href=https://whitea029.github.io/images/apple-touch-icon.png><link rel=mask-icon href=https://whitea029.github.io/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://whitea029.github.io/posts/golang/channel/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:url" content="https://whitea029.github.io/posts/golang/channel/"><meta property="og:site_name" content="Whitea's Blog"><meta property="og:title" content="ç¡¬æ ¸â€”â€”golangä¹‹channelã€select"><meta property="og:description" content="å…³äºä½œè€…å¯¹golangæ•°æ®ç»“æ„channelå’Œselectè¯­å¥åº•å±‚åŸç†çš„å­¦ä¹ ä¸æ€è€ƒ"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-03-20T11:30:03+00:00"><meta property="article:modified_time" content="2025-03-20T11:30:03+00:00"><meta property="article:tag" content="Go"><meta property="og:image" content="https://whitea029.github.io/%3Cimage%20path/url%3E"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://whitea029.github.io/%3Cimage%20path/url%3E"><meta name=twitter:title content="ç¡¬æ ¸â€”â€”golangä¹‹channelã€select"><meta name=twitter:description content="å…³äºä½œè€…å¯¹golangæ•°æ®ç»“æ„channelå’Œselectè¯­å¥åº•å±‚åŸç†çš„å­¦ä¹ ä¸æ€è€ƒ"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://whitea029.github.io/posts/"},{"@type":"ListItem","position":2,"name":"ç¡¬æ ¸â€”â€”golangä¹‹channelã€select","item":"https://whitea029.github.io/posts/golang/channel/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"ç¡¬æ ¸â€”â€”golangä¹‹channelã€select","name":"ç¡¬æ ¸â€”â€”golangä¹‹channelã€select","description":"å…³äºä½œè€…å¯¹golangæ•°æ®ç»“æ„channelå’Œselectè¯­å¥åº•å±‚åŸç†çš„å­¦ä¹ ä¸æ€è€ƒ","keywords":["Go"],"articleBody":"åœ¨æ—¥å¸¸å¼€å‘ä¸­ï¼Œæ•°æ®ç»“æ„channelå’Œselectè¯­å¥è¢«é«˜é¢‘ä½¿ç”¨ï¼Œæœ¬æ–‡åŸºäºGo1.18.1ç‰ˆæœ¬çš„æºç ï¼Œæ¢è®¨channelçš„åº•å±‚æ•°æ®ç»“æ„å’Œselectè®¿é—®Channelåœ¨ç¼–è¯‘æœŸå’Œè¿è¡Œæ—¶çš„åº•å±‚åŸç†\næ¢è®¨åº•å±‚åŸç†æ˜¯ä¸€ä¸ªå¾ˆå¥‡å¦™å´æ¯ç‡¥ä¹å‘³çš„è¿‡ç¨‹ï¼Œå¸Œæœ›è¯»è€…æ‚¨èƒ½ä¿æŒè¶³å¤Ÿçš„è€å¿ƒï¼Œæˆ‘ä»¬å¼€å§‹å§ğŸ¤—\nchannel çš„åº•å±‚æ•°æ®ç»“æ„ 1 ch := make(chan it, 5) æˆ‘ä»¬é€šè¿‡makeå…³é”®å­—åˆ›å»ºäº†ä¸€ä¸ªç¼“å†²åŒºä¸º5å­˜å‚¨æ•°æ®ç±»å‹ä¸ºintçš„channel chå­˜å‚¨åœ¨æ ˆä¸Šçš„ä¸€ä¸ªæŒ‡é’ˆï¼Œè€ŒæŒ‡å‘çš„æ˜¯å †ä¸Šçš„hchanç»“æ„ä½“ é¦–å…ˆä¸€ä¸ªchanneléœ€è¦èƒ½æ”¯æŒå¤šä¸ªgoroutineå¹¶å‘è®¿é—®ï¼Œè¿™éœ€è¦ä¸€æŠŠğŸ”’(lock mutex)\nå¯¹äºæœ‰ç¼“å†²åŒºçš„channelè€Œè¨€ï¼Œéœ€è¦çŸ¥é“ç¼“å†²åŒºçš„ä½ç½®(buf unsafe.Pointer)ä»¥åŠç¼“å†²åŒºå†…æœ‰å¤šå°‘ä¸ªå…ƒç´ (qcount unit)ï¼Œæ¯ä¸ªå…ƒç´ å¤šå¤§(datasiz uint)ï¼Œæ‰€ä»¥ç¼“å†²åŒºå®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªæ•°ç»„\nå› ä¸ºgolangè¿è¡Œæ—¶ä¸­å†…å­˜å¤åˆ¶ã€åƒåœ¾å›æ”¶ç­‰æœºåˆ¶ä¾èµ–æ•°æ®çš„ç±»å‹ä¿¡æ¯ï¼Œæ‰€ä»¥è¿˜éœ€è¦ä¸€ä¸ªæŒ‡é’ˆ(elemtype *_type)æŒ‡å‘æ•°æ®çš„ç±»å‹å…ƒæ•°æ®\nä¸ºäº†æ”¯æŒå®šæ—¶å™¨çš„åŠŸèƒ½æ·»åŠ äº†timer *timer\nchannelæ”¯æŒäº¤æ›¿çš„è¯»å†™ï¼Œéœ€è¦åˆ†åˆ«è®°å½•è¯»å’Œå†™ä¸‹æ ‡çš„ä½ç½®(sendx uint recvx uint)ï¼Œå½“è¯»å’Œå†™ä¸èƒ½ç«‹å³å®Œæˆçš„æ—¶å€™ï¼Œéœ€è¦èƒ½å¤Ÿè®©å½“å‰çš„goroutineåœ¨channelä¸Šç­‰å¾…ï¼Œå½“æ¡ä»¶æ»¡è¶³æ—¶ï¼Œéœ€è¦å¯ä»¥ç«‹å³å”¤é†’ç­‰å¾…ä¸­çš„goroutineï¼Œæ‰€æœ‰éœ€è¦ä¸¤ä¸ªç­‰å¾…é˜Ÿåˆ—æ¥é’ˆå¯¹è¯»å’Œå†™æ“ä½œ(sendq waitq recvq waitq)\nchannelæ”¯æŒè¢«å…³é—­(closed uint32)\nç»¼ä¸Šæ‰€è¿°ï¼Œchannelçš„åº•å±‚æ•°æ®ç»“æ„å°±é•¿è¿™ä¸ªæ ·å­\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 type hchan struct { qcount uint // total data in the queue dataqsiz uint // size of the circular queue buf unsafe.Pointer // points to an array of dataqsiz elements elemsize uint16 closed uint32 timer *timer // timer feeding this chan elemtype *_type // element type sendx uint // send index recvx uint // receive index recvq waitq // list of recv waiters sendq waitq // list of send waiters // lock protects all fields in hchan, as well as several // fields in sudogs blocked on this channel. // // Do not change another G's status while holding this lock // (in particular, do not ready a G), as this can deadlock // with stack shrinking. lock mutex } å½“æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæœ‰ç¼“å†²åŒºçš„channelçš„æ—¶å€™ï¼Œrecvxå’Œsendxéƒ½ä¸º0,ä¸æ–­å¾€channelä¸­å‘é€æ•°æ®çš„æ—¶å€™ï¼Œå› ä¸ºæ²¡æœ‰goroutineåœ¨ç­‰å¾…æ¥æ”¶æˆ–å‘é€æ•°æ®ï¼Œæ‰€ä»¥sendä¼šä¸æ–­å‘åç§»åŠ¨ï¼Œæœ€åç§»åŠ¨å›èµ·ç‚¹(recvx = sendx)ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™åˆ™è¡¨æ˜channelçš„ç¼“å†²åŒºæ»¡äº†ï¼Œå…¶å®channelçš„ç¼“å†²åŒºæ˜¯ä¸€ä¸ªç¯å½¢é˜Ÿåˆ—ï¼Œä¹Ÿç§°ä¹‹ä¸ºç¯å½¢ç¼“å†²åŒº\né‚£å¦‚æœå½“ç¼“å†²åŒºæ»¡äº†ä¹‹åï¼Œgoroutineè¿˜æƒ³å¾€channelä¸­å‘é€æ•°æ®ï¼Œè¿™ä¸ªæ—¶å€™goroutineå°±ä¼šè¿›å…¥åˆ°å‘é€ç­‰å¾…é˜Ÿåˆ—sendqï¼ˆè¿™æ˜¯ä¸€ä¸ªsudogç±»å‹çš„é“¾è¡¨ï¼‰ï¼Œsudogä¸­çš„g *gå°±è®°å½•è¯¥goroutineçš„ä¿¡æ¯ï¼Œc *hchanè®°å½•ç€åœ¨ç­‰å¾…å“ªä¸ªchannelï¼Œelem unsafe.Pointerå­˜å‚¨ç€æ•°æ®æŒ‡é’ˆã€‚ä¸‹é¢æ˜¯æˆªå–çš„æºç æ³¨é‡Š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 type waitq struct { first *sudog last *sudog } type sudog struct { // The following fields are protected by the hchan.lock of the // channel this sudog is blocking on. shrinkstack depends on // this for sudogs involved in channel ops. g *g next *sudog prev *sudog elem unsafe.Pointer // data element (may point to stack) // The following fields are never accessed concurrently. // For channels, waitlink is only accessed by g. // For semaphores, all fields (including the ones above) // are only accessed when holding a semaRoot lock. acquiretime int64 releasetime int64 ticket uint32 // isSelect indicates g is participating in a select, so // g.selectDone must be CAS'd to win the wake-up race. isSelect bool // success indicates whether communication over channel c // succeeded. It is true if the goroutine was awoken because a // value was delivered over channel c, and false if awoken // because c was closed. success bool // waiters is a count of semaRoot waiting list other than head of list, // clamped to a uint16 to fit in unused space. // Only meaningful at the head of the list. // (If we wanted to be overly clever, we could store a high 16 bits // in the second entry in the list.) waiters uint16 parent *sudog // semaRoot binary tree waitlink *sudog // g.waiting list or semaRoot waittail *sudog // semaRoot c *hchan // channel } æ˜¾ç„¶ï¼Œå½“å¦å¤–ä¸€ä¸ªgoroutineè¿›æ¥è¯»å–channelçš„æ•°æ®ï¼Œrecvxå‘åç§»åŠ¨ï¼Œç¼“å†²åŒºåˆæœ‰äº†ç©ºé—´ï¼Œè¿™æ—¶ä¼šå”¤é†’ç­‰å¾…é˜Ÿåˆ—ä¸­çš„goroutineï¼Œè®©å…¶æ‰§è¡Œå†™å…¥æ•°æ®çš„æ“ä½œ\nåˆ°è¿™é‡Œæˆ‘ä»¬å°±è®¤è¯†åˆ°äº†channelåº•å±‚çš„æ•°æ®ç»“æ„\nå‘é€æ•°æ®åˆ°channel å½“channelçš„ç¼“å†²åŒºæ»¡è¶³ä»¥ä¸‹æ¡ä»¶æ‰æ˜¯ä¸é˜»å¡çš„ï¼š\nç¼“å†²åŒºè¿˜æœ‰ç©ºé—²ä½ç½® æ¥æ”¶ç­‰å¾…é˜Ÿåˆ—ä¸­è¿˜æœ‰é˜»å¡ç­‰å¾…çš„goroutine ç›¸åï¼Œé˜»å¡çš„æ¡ä»¶åˆ™æ˜¯ï¼š\nchannelä¸ºnil channelæ— ç¼“å†²åŒºä¸”æ¥æ”¶é˜Ÿåˆ—ä¸­æ²¡æœ‰é˜»å¡ç­‰å¾…çš„goroutine ç¼“å†²åŒºæ»¡äº†ä¸”æ¥æ”¶é˜Ÿåˆ—ä¸­æ²¡æœ‰é˜»å¡ç­‰å¾…çš„goroutine å› æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡è°ƒæ•´å†™ä»£ç çš„æ–¹å¼å°½é‡ä¸é˜»å¡\nå…è®¸é˜»å¡å¼ä»£ç ï¼š\n1 ch \u003c- 10 éé˜»å¡å¼ä»£ç ï¼š\n1 2 3 4 5 6 select { case ch \u003c- 10: ... default: ... } å¦‚æœä¸Šé¢çš„caseé˜»å¡äº†ï¼Œå°±ä¼šè¿›å…¥åˆ°defaultåˆ†æ”¯å½“ä¸­\nè¿™æ˜¯å‘é€æ•°æ®çš„å†™æ³•ï¼Œæ¥æ”¶æ•°æ®çš„å†™æ³•ä¼šæ›´å¤šä¸€ç‚¹\nä»channelä¸­æ¥æ”¶æ•°æ® ä»channelä¸­æ¥æ”¶æ•°æ®ä¸é˜»å¡ï¼š\nç¼“å†²åŒºå­˜åœ¨æ•°æ® æ²¡æœ‰ç¼“å†²åŒºä½†æ˜¯sendqä¸­æœ‰é˜»å¡ç­‰å¾…å‘é€çš„goroutine ç›¸åï¼Œé˜»å¡çš„æƒ…å†µä¸ºï¼š\nchannelä¸ºnil æ²¡æœ‰ç¼“å†²åŒºä¸”sendqä¸­æ²¡æœ‰é˜»å¡ç­‰å¾…å‘é€çš„goroutine ç¼“å†²åŒºä¸ºç©ºä¸”sendqä¸­æ²¡æœ‰é˜»å¡ç­‰å¾…å‘é€çš„goroutine å…è®¸é˜»å¡å¼ä»£ç ï¼š\n1 2 3 4 5 6 7 8 // ä¸¢å¼ƒchä¸­æ¥æ”¶çš„æ•°æ® \u003c-ch // å°†æ¥æ”¶çš„æ•°æ®èµ‹å€¼ç»™v v := \u003c-ch // Comma-oké£æ ¼å†™æ³• v, ok := \u003c-ch éé˜»å¡å¼ä»£ç ï¼š\n1 2 3 4 5 6 select { case \u003c-ch: ... default: ... } è¿™é‡Œçš„selectåªé’ˆå¯¹ä½†ä¸ªchannelçš„æ“ä½œï¼Œå¤šè·¯selectåˆæœ‰æ‰€ä¸åŒ\nå¤šè·¯select å¤šè·¯selectæŒ‡çš„å­˜åœ¨ä¸¤ä¸ªæˆ–æ›´å¤šçš„caseåˆ†æ”¯ï¼Œæ¯ä¸ªåˆ†æ”¯å¯ä»¥æ˜¯ä¸€ä¸ªchannelçš„sendå’Œrecvæ“ä½œ\ngolangçš„selectè¯­å¥é‡‡ç”¨çš„æ˜¯å¤šè·¯å¤ç”¨çš„æ€æƒ³ï¼Œæœ¬è´¨ä¸Šæ˜¯ä¸ºäº†è¾¾åˆ°é€šè¿‡ä¸€ä¸ªåç¨‹åŒæ—¶å¤„ç†å¤šä¸ªIOè¯·æ±‚ï¼ˆChannelè¯»å†™äº‹ä»¶ï¼‰\nå¤šè·¯selectä¼šè¢«golangç¼–è¯‘å™¨è½¬åŒ–ä¸ºå¯¹runtime.selectgo()çš„å‡½æ•°è°ƒç”¨ï¼Œç”±äºè¯¥å‡½æ•°æºç æœ‰å››ç™¾å¤šè¡Œï¼Œé‚£æˆ‘ä»¬å…ˆä»å‡½æ•°çš„å…¥å‚å’Œå‡ºå‚çœ‹å§\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 // selectgo implements the select statement. // // cas0 points to an array of type [ncases]scase, and order0 points to // an array of type [2*ncases]uint16 where ncases must be \u003c= 65536. // Both reside on the goroutine's stack (regardless of any escaping in // selectgo). // // For race detector builds, pc0 points to an array of type // [ncases]uintptr (also on the stack); for other builds, it's set to // nil. // // selectgo returns the index of the chosen scase, which matches the // ordinal position of its respective select{recv,send,default} call. // Also, if the chosen scase was a receive operation, it reports whether // a value was received. func selectgo(cas0 *scase, order0 *uint16, pc0 *uintptr, nsends, nrecvs int, block bool) (int, bool) cas0 *scaseæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œç”¨äºå­˜å‚¨selectçš„caseåˆ†æ”¯\norder0 *uint16æŒ‡å‘çš„æ˜¯ä¸€ä¸ªç±»å‹ä¸ºuint16çš„æ•°ç»„ï¼Œå…¶é•¿åº¦æ˜¯åˆ†æ”¯æ•°é‡çš„2å€ï¼Œå‰é¢ä¸€åŠç”¨äºå¯¹æ¯ä¸ªchannelçš„ä¹±åºè½®è¯¢ï¼ˆä¿è¯å…¬å¹³æ€§ï¼‰ï¼Œåé¢ä¸€åŠç”¨äºæœ‰åºçš„å¯¹æ¯ä¸ªchannelåŠ é”ï¼ˆåˆç†çš„åŠ é”é¡ºåºæ‰èƒ½é¿å…æ­»é”ï¼‰\npc0 *uintpträ¸golangçš„raceæ£€æµ‹ç›¸å…³ race-detectorï¼Œè¿™é‡Œä¸å±•å¼€è¯´\nnsends, nrecvs intåˆ†åˆ«è®°å½•ç”¨äºsendå’Œrecvæ“ä½œçš„åˆ†æ”¯åˆ†åˆ«æœ‰å¤šå°‘ä¸ª\nblock boolè¡¨ç¤ºæ˜¯å¦é˜»å¡ï¼Œå³æœ‰defaultä¸ºfalseï¼Œåä¹‹ä¸ºtrue\næˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹æ‰§è¡Œè¿‡ç¨‹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 func selectgo(cas0 *scase, order0 *uint16, pc0 *uintptr, nsends, nrecvs int, block bool) (int, bool) { ...... // ä¸ºäº†å°†scaseåˆ†é…åˆ°æ ˆä¸Šï¼Œè¿™é‡Œç›´æ¥ç»™cas1åˆ†é…äº†64KBå¤§å°çš„æ•°ç»„ï¼ŒåŒç†ï¼Œ ç»™order1åˆ†é…äº†128KBå¤§å°çš„æ•°ç»„ cas1 := (*[1 \u003c\u003c 16]scase)(unsafe.Pointer(cas0)) order1 := (*[1 \u003c\u003c 17]uint16)(unsafe.Pointer(order0)) // ncasesä¸ªæ•°æ˜¯å‘é€chanä¸ªæ•°nsendsåŠ ä¸Šæ¥æ”¶chanä¸ªæ•°nrecvs ncases := nsends + nrecvs // scasesåˆ‡ç‰‡æ˜¯ä¸Šé¢åˆ†é…cas1æ•°ç»„çš„å‰ncasesä¸ªå…ƒç´  scases := cas1[:ncases:ncases] // é¡ºåºåˆ—è¡¨pollorderæ˜¯order1æ•°ç»„çš„å‰ncasesä¸ªå…ƒç´  pollorder := order1[:ncases:ncases] // åŠ é”åˆ—è¡¨lockorderæ˜¯order1æ•°ç»„çš„ç¬¬äºŒæ‰¹ncaseä¸ªå…ƒç´  // æ‰€ä»¥è¯´order0æŒ‡å‘çš„æ•°ç»„æ˜¯caseæ•°é‡çš„ä¸¤å€ï¼Œåˆ†æˆå‰ä¸€åŠå’Œåä¸€åŠä½¿ç”¨ lockorder := order1[ncases:][:ncases:ncases] ...... // ç”Ÿæˆæ’åˆ—é¡ºåºï¼ˆé¿å… channel çš„é¥¥é¥¿é—®é¢˜ï¼Œä¿è¯å…¬å¹³æ€§ï¼‰ norder := 0 for i := range scases { cas := \u0026scases[i] // å¤„ç†caseä¸­channelä¸ºç©ºçš„æƒ…å†µ if cas.c == nil { cas.elem = nil // å°†elemç½®ç©ºï¼Œä¾¿äºGC continue } // é€šè¿‡fastrandnå‡½æ•°å¼•å…¥éšæœºæ€§ï¼Œç¡®å®špollorderåˆ—è¡¨ä¸­caseçš„éšæœºé¡ºåºç´¢å¼• j := fastrandn(uint32(norder + 1)) pollorder[norder] = pollorder[j] pollorder[j] = uint16(i) norder++ } pollorder = pollorder[:norder] lockorder = lockorder[:norder] // æ ¹æ®chanåœ°å€ç¡®å®šlockorderåŠ é”æ’åºåˆ—è¡¨çš„é¡ºåº // é€šè¿‡ç®€å•çš„å †æ’åºï¼Œä»¥nlognæ—¶é—´å¤æ‚åº¦å®Œæˆæ’åº for i := range lockorder { j := i // Start with the pollorder to permute cases on the same channel. c := scases[pollorder[i]].c for j \u003e 0 \u0026\u0026 scases[lockorder[(j-1)/2]].c.sortkey() \u003c c.sortkey() { k := (j - 1) / 2 lockorder[j] = lockorder[k] j = k } lockorder[j] = pollorder[i] } for i := len(lockorder) - 1; i \u003e= 0; i-- { o := lockorder[i] c := scases[o].c lockorder[i] = lockorder[0] j := 0 for { k := j*2 + 1 if k \u003e= i { break } if k+1 \u003c i \u0026\u0026 scases[lockorder[k]].c.sortkey() \u003c scases[lockorder[k+1]].c.sortkey() { k++ } if c.sortkey() \u003c scases[lockorder[k]].c.sortkey() { lockorder[j] = lockorder[k] j = k continue } break } lockorder[j] = o } ...... } åŠ é”å’Œè§£é”è°ƒç”¨çš„æ˜¯runtime.sellock()å‡½æ•°å’Œruntime.selunlock()å‡½æ•°ã€‚ä»ä¸‹é¢çš„ä»£ç é€»è¾‘ä¸­å¯ä»¥çœ‹åˆ°ï¼Œä¸¤ä¸ªå‡½æ•°åˆ†åˆ«æ˜¯æŒ‰lockorderé¡ºåºå¯¹channelåŠ é”ï¼Œä»¥åŠæŒ‰lockorderé€†åºé‡Šæ”¾é”ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 func sellock(scases []scase, lockorder []uint16) { var c *hchan for _, o := range lockorder { c0 := scases[o].c if c0 != c { c = c0 lock(\u0026c.lock) } } } func selunlock(scases []scase, lockorder []uint16) { for i := len(lockorder) - 1; i \u003e= 0; i-- { c := scases[lockorder[i]].c if i \u003e 0 \u0026\u0026 c == scases[lockorder[i-1]].c { continue } unlock(\u0026c.lock) } } æ¥ä¸‹æ¥å°±æ˜¯selectgoçš„ä¸»é€»è¾‘å•¦ï¼ˆå¥½é•¿ğŸ˜­ï¼‰\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 func selectgo(cas0 *scase, order0 *uint16, pc0 *uintptr, nsends, nrecvs int, block bool) (int, bool) { ...... sellock(scases, lockorder) ...... // é˜¶æ®µä¸€: æŸ¥æ‰¾å¯ä»¥å¤„ç†çš„channel var casi int var cas *scase var caseSuccess bool var caseReleaseTime int64 = -1 var recvOK bool for _, casei := range pollorder { casi = int(casei) // caseçš„ç´¢å¼• cas = \u0026scases[casi] // å½“å‰çš„case c = cas.c if casi \u003e= nsends { // å¤„ç†æ¥æ”¶channelçš„case sg = c.sendq.dequeue() // å¦‚æœå½“å‰channelçš„sendqä¸Šæœ‰ç­‰å¾…çš„goroutineï¼Œå°±ä¼šè·³åˆ° recvæ ‡ç­¾å¹¶ä»ç¼“å†²åŒºè¯»å–æ•°æ®åå°†ç­‰å¾…goroutineä¸­çš„æ•°æ®æ”¾å…¥åˆ°ç¼“å†²åŒºä¸­ç›¸åŒçš„ä½ç½®ï¼› if sg != nil { goto recv } if c.qcount \u003e 0 { //å¦‚æœå½“å‰channelçš„ç¼“å†²åŒºä¸ä¸ºç©ºï¼Œå°±ä¼šè·³åˆ°bufrecvæ ‡ç­¾å¤„ä»ç¼“å†²åŒºè·å–æ•°æ®ï¼› goto bufrecv } if c.closed != 0 { //å¦‚æœå½“å‰channelå·²ç»è¢«å…³é—­ï¼Œå°±ä¼šè·³åˆ°rcloseåšä¸€äº›æ¸…é™¤çš„æ”¶å°¾å·¥ä½œï¼› goto rclose } } else { // å¤„ç†å‘é€channelçš„case ...... if c.closed != 0 { // å¦‚æœå½“å‰channelå·²ç»è¢«å…³é—­å°±ä¼šç›´æ¥è·³åˆ°scloseæ ‡ç­¾ï¼Œè§¦å‘ panic å°è¯•ä¸­æ­¢ç¨‹åºï¼› goto sclose } sg = c.recvq.dequeue() if sg != nil { // å¦‚æœå½“å‰channelçš„recvqä¸Šæœ‰ç­‰å¾…çš„goroutineï¼Œå°±ä¼šè·³åˆ° sendæ ‡ç­¾å‘channelå‘é€æ•°æ®ï¼› goto send } if c.qcount \u003c c.dataqsiz { // å¦‚æœå½“å‰channelçš„ç¼“å†²åŒºå­˜åœ¨ç©ºé—²ä½ç½®ï¼Œå°±ä¼šå°†å¾…å‘é€çš„æ•°æ®å­˜å…¥ç¼“å†²åŒºï¼› goto bufsend } } } if !block { // å¦‚æœæ˜¯éé˜»å¡ï¼Œå³åŒ…å«defaultåˆ†æ”¯ï¼Œä¼šè§£é”æ‰€æœ‰ Channel å¹¶è¿”å› selunlock(scases, lockorder) casi = -1 goto retc } // é˜¶æ®µ2: å°†å½“å‰goroutineæ ¹æ®éœ€è¦æŒ‚åœ¨chançš„sendqå’Œrecvqä¸Š gp = getg() if gp.waiting != nil { throw(\"gp.waiting != nil\") } nextp = \u0026gp.waiting for _, casei := range lockorder { casi = int(casei) cas = \u0026scases[casi] c = cas.c // è·å–sudogï¼Œå°†å½“å‰goroutineç»‘å®šåˆ°sudogä¸Š sg := acquireSudog() sg.g = gp sg.isSelect = true sg.elem = cas.elem sg.releasetime = 0 if t0 != 0 { sg.releasetime = -1 } sg.c = c *nextp = sg nextp = \u0026sg.waitlink // åŠ å…¥ç›¸åº”ç­‰å¾…é˜Ÿåˆ— if casi \u003c nsends { c.sendq.enqueue(sg) } else { c.recvq.enqueue(sg) } } ...... // è¢«å”¤é†’åä¼šæ ¹æ® param æ¥åˆ¤æ–­æ˜¯å¦æ˜¯ç”± close æ“ä½œå”¤é†’çš„ï¼Œæ‰€ä»¥å…ˆç½®ä¸º nil gp.param = nil ...... // æŒ‚èµ·å½“å‰goroutine gopark(selparkcommit, nil, waitReasonSelect, traceEvGoBlockSelect, 1) // åŠ é”æ‰€æœ‰çš„channel sellock(scases, lockorder) gp.selectDone = 0 // param å­˜æ”¾å”¤é†’ goroutine çš„ sudogï¼Œå¦‚æœæ˜¯å…³é—­æ“ä½œå”¤é†’çš„ï¼Œé‚£ä¹ˆå°±ä¸º nil sg = (*sudog)(gp.param) gp.param = nil casi = -1 cas = nil caseSuccess = false // å½“å‰goroutine çš„ waiting é“¾è¡¨æŒ‰ç…§lockorderé¡ºåºå­˜æ”¾ç€caseçš„sudog sglist = gp.waiting // åœ¨ä» gp.waiting å–æ¶ˆcaseçš„sudogé“¾æ¥ä¹‹å‰æ¸…é™¤æ‰€æœ‰å…ƒç´ ï¼Œä¾¿äºGC for sg1 := gp.waiting; sg1 != nil; sg1 = sg1.waitlink { sg1.isSelect = false sg1.elem = nil sg1.c = nil } // æ¸…æ¥šå½“å‰goroutineçš„waitingé“¾è¡¨ï¼Œå› ä¸ºè¢«sgä»£è¡¨çš„åç¨‹å”¤é†’äº† gp.waiting = nil for _, casei := range lockorder { k = \u0026scases[casei] // å¦‚æœç›¸ç­‰è¯´æ˜ï¼Œgoroutineæ˜¯è¢«å½“å‰caseçš„channelæ”¶å‘æ“ä½œå”¤é†’çš„ if sg == sglist { // sgå”¤é†’äº†å½“å‰goroutine, åˆ™å½“å‰Gå·²ç»ä»sgçš„é˜Ÿåˆ—ä¸­å‡ºé˜Ÿï¼Œè¿™é‡Œä¸éœ€è¦å†æ¬¡å‡ºé˜Ÿ casi = int(casei) cas = k caseSuccess = sglist.success if sglist.releasetime \u003e 0 { caseReleaseTime = sglist.releasetime } } else { // ä¸æ˜¯æ­¤caseå”¤é†’å½“å‰goroutine, å°†goroutineä»æ­¤caseçš„å‘é€é˜Ÿåˆ—æˆ–æ¥æ”¶é˜Ÿåˆ—å‡ºé˜Ÿ c = k.c if int(casei) \u003c nsends { c.sendq.dequeueSudoG(sglist) } else { c.recvq.dequeueSudoG(sglist) } } // é‡Šæ”¾å½“å‰caseçš„sudogï¼Œç„¶åå¤„ç†ä¸‹ä¸€ä¸ªcaseçš„sudog sgnext = sglist.waitlink sglist.waitlink = nil releaseSudog(sglist) sglist = sgnext } } // æœ€åçš„ä»£ç æ˜¯å¾ªç¯ç¬¬ä¸€é˜¶æ®µç”¨åˆ°çš„è·³è½¬æ ‡ç­¾ä»£ç æ®µ bufrecv: ...... recvOK = true qp = chanbuf(c, c.recvx) if cas.elem != nil { typedmemmove(c.elemtype, cas.elem, qp) } typedmemclr(c.elemtype, qp) c.recvx++ if c.recvx == c.dataqsiz { c.recvx = 0 } c.qcount-- selunlock(scases, lockorder) goto retc bufsend: ...... typedmemmove(c.elemtype, chanbuf(c, c.sendx), cas.elem) c.sendx++ if c.sendx == c.dataqsiz { c.sendx = 0 } c.qcount++ selunlock(scases, lockorder) goto retc recv: // å¯ä»¥ç›´æ¥ä»ä¼‘çœ çš„goroutineè·å–æ•°æ® recv(c, sg, cas.elem, func() { selunlock(scases, lockorder) }, 2) ...... recvOK = true goto retc rclose: //ä»ä¸€ä¸ªå…³é—­ channel ä¸­æ¥æ”¶æ•°æ®ä¼šç›´æ¥æ¸…é™¤ Channel ä¸­çš„ç›¸å…³å†…å®¹ï¼› selunlock(scases, lockorder) recvOK = false if cas.elem != nil { typedmemclr(c.elemtype, cas.elem) } ...... goto retc send: ...... // å¯ä»¥ç›´æ¥ä»ä¼‘çœ çš„goroutineè·å–æ•°æ® send(c, sg, cas.elem, func() { selunlock(scases, lockorder) }, 2) if debugSelect { print(\"syncsend: cas0=\", cas0, \" c=\", c, \"\\n\") } goto retc retc: // é€€å‡ºselectgo()å‡½æ•° if caseReleaseTime \u003e 0 { blockevent(caseReleaseTime-t0, 1) } return casi, recvOK sclose: // å‘ä¸€ä¸ªå…³é—­çš„ channel å‘é€æ•°æ®å°±ä¼šç›´æ¥ panic é€ æˆç¨‹åºå´©æºƒï¼› selunlock(scases, lockorder) panic(plainError(\"send on closed channel\")) æ€»ç»“ä¸€ä¸‹\nselectgoå‡½æ•°æ‰§è¡Œæ—¶ä¼šå…ˆæŒ‰ç…§æœ‰åºçš„åŠ é”é¡ºåºå¯¹æ‰€æœ‰çš„channelè¿›è¡ŒåŠ é”\nç„¶åæŒ‰ç…§ä¹±åºçš„è½®è¯¢é¡ºåºæ£€æŸ¥æ‰€æœ‰channelçš„ç­‰å¾…é˜Ÿåˆ—å’Œç¼“å†²åŒºï¼Œå‡å¦‚æ£€æŸ¥åˆ°æŸä¸ªchannelæœ‰æ•°æ®å¯æ“ä½œï¼Œå°±ä¼šç›´æ¥æ‹·è´æ•°æ®è¿›å…¥ç›¸åº”çš„caseåˆ†æ”¯\nå¦‚æœæ‰€æœ‰çš„channeléƒ½ä¸å¯æ“ä½œï¼Œå°±æŠŠå½“å‰çš„åç¨‹æ·»åŠ åˆ°æ‰€æœ‰channelçš„sendqæˆ–recvqä¸­\næ¥ç€è¯¥åç¨‹ä¼šæŒ‚èµ·ï¼Œå¹¶è§£é”æ‰€æœ‰çš„channel\nåŠ å…¥ç°åœ¨æŸä¸ªchannelæœ‰æ•°æ®å¯æ“ä½œäº†ï¼Œå°±ä¼šå”¤é†’è¯¥åç¨‹è¿›å…¥caseåˆ†æ”¯\nå®Œæˆå¯¹åº”åˆ†æ”¯çš„æ“ä½œä¹‹åï¼Œä¼šå†æ¬¡æŒ‰ç…§åŠ é”é¡ºåºå¯¹æ‰€æœ‰channelè¿›è¡ŒåŠ é”ï¼Œç„¶åä»æ‰€æœ‰sendqæˆ–recvqä¸­å°†è‡ªå·±ç§»é™¤\næœ€åå…¨éƒ¨è§£é”åè¿”å›\nç¼–è¯‘å™¨è¿˜å¯¹selectåšäº†å“ªäº›å¤„ç† è¿™é‡Œä¸»è¦è¿˜æƒ³æåˆ°çš„æ˜¯src/cmd/compile/internal/walk/select.goä¸­çš„walkSelectCases()\nè¯¥å‡½æ•°æ˜¯å¯¹selectä¸åŒcaseåˆ†æ”¯æ¡ä»¶çš„å¤„ç†ï¼Œä¸åŒçš„æƒ…å†µä¼šè°ƒç”¨ä¸åŒçš„è¿è¡Œæ—¶å‡½æ•°ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º\nå…·ä½“å…³äºwalkSelectCases()çš„æºç å°±æš‚æ—¶ä¸åœ¨è¿™é‡Œå±•å¼€å•¦\nä½œä¸ºä¸€åå¤§äºŒå°ç™½Gopherï¼Œæ–‡ç« å­˜åœ¨æœ‰ä»»ä½•é—®é¢˜éƒ½å¯ä»¥è”ç³»æˆ‘ï¼Œå½“ç„¶ä¹Ÿæ¬¢è¿ä¸æˆ‘äº¤æµæŠ€æœ¯ç›¸å…³çš„é—®é¢˜ï¼Œæ„Ÿè°¢ä½ çš„é˜…è¯»ğŸ¤—\n","wordCount":"1856","inLanguage":"en","image":"https://whitea029.github.io/%3Cimage%20path/url%3E","datePublished":"2025-03-20T11:30:03Z","dateModified":"2025-03-20T11:30:03Z","author":{"@type":"Person","name":"Whitea"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://whitea029.github.io/posts/golang/channel/"},"publisher":{"@type":"Organization","name":"Whitea's Blog","logo":{"@type":"ImageObject","url":"https://whitea029.github.io/images/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://whitea029.github.io/ accesskey=h title="Home (Alt + H)"><img src=https://whitea029.github.io/apple-touch-icon.png alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://whitea029.github.io/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://whitea029.github.io/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://whitea029.github.io/>Home</a>&nbsp;Â»&nbsp;<a href=https://whitea029.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">ç¡¬æ ¸â€”â€”golangä¹‹channelã€select</h1><div class=post-description>å…³äºä½œè€…å¯¹golangæ•°æ®ç»“æ„channelå’Œselectè¯­å¥åº•å±‚åŸç†çš„å­¦ä¹ ä¸æ€è€ƒ</div><div class=post-meta><span title='2025-03-20 11:30:03 +0000 +0000'>March 20, 2025</span>&nbsp;Â·&nbsp;9 min&nbsp;Â·&nbsp;1856 words&nbsp;Â·&nbsp;Whitea&nbsp;|&nbsp;<a href=https://github.com/Whitea029/myblog/blob/main/content/posts/golang/channel/index.md rel="noopener noreferrer" target=_blank>Source Code</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#channel-çš„åº•å±‚æ•°æ®ç»“æ„>channel çš„åº•å±‚æ•°æ®ç»“æ„</a></li><li><a href=#å‘é€æ•°æ®åˆ°channel>å‘é€æ•°æ®åˆ°channel</a></li><li><a href=#ä»channelä¸­æ¥æ”¶æ•°æ®>ä»channelä¸­æ¥æ”¶æ•°æ®</a></li><li><a href=#å¤šè·¯select>å¤šè·¯select</a></li><li><a href=#ç¼–è¯‘å™¨è¿˜å¯¹selectåšäº†å“ªäº›å¤„ç†>ç¼–è¯‘å™¨è¿˜å¯¹selectåšäº†å“ªäº›å¤„ç†</a></li></ul></nav></div></details></div><div class=post-content><p>åœ¨æ—¥å¸¸å¼€å‘ä¸­ï¼Œæ•°æ®ç»“æ„channelå’Œselectè¯­å¥è¢«é«˜é¢‘ä½¿ç”¨ï¼Œæœ¬æ–‡åŸºäºGo1.18.1ç‰ˆæœ¬çš„æºç ï¼Œæ¢è®¨channelçš„åº•å±‚æ•°æ®ç»“æ„å’Œselectè®¿é—®Channelåœ¨ç¼–è¯‘æœŸå’Œè¿è¡Œæ—¶çš„åº•å±‚åŸç†</p><p>æ¢è®¨åº•å±‚åŸç†æ˜¯ä¸€ä¸ªå¾ˆå¥‡å¦™å´æ¯ç‡¥ä¹å‘³çš„è¿‡ç¨‹ï¼Œå¸Œæœ›è¯»è€…æ‚¨èƒ½ä¿æŒè¶³å¤Ÿçš„è€å¿ƒï¼Œæˆ‘ä»¬å¼€å§‹å§ğŸ¤—</p><h2 id=channel-çš„åº•å±‚æ•°æ®ç»“æ„>channel çš„åº•å±‚æ•°æ®ç»“æ„<a hidden class=anchor aria-hidden=true href=#channel-çš„åº•å±‚æ•°æ®ç»“æ„>#</a></h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-0-1><a class=lnlinks href=#hl-0-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>ch</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=nx>it</span><span class=p>,</span> <span class=mi>5</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>æˆ‘ä»¬é€šè¿‡<code>make</code>å…³é”®å­—åˆ›å»ºäº†ä¸€ä¸ªç¼“å†²åŒºä¸º<code>5</code>å­˜å‚¨æ•°æ®ç±»å‹ä¸º<code>int</code>çš„<code>channel</code>
chå­˜å‚¨åœ¨æ ˆä¸Šçš„ä¸€ä¸ªæŒ‡é’ˆï¼Œè€ŒæŒ‡å‘çš„æ˜¯å †ä¸Šçš„<code>hchan</code>ç»“æ„ä½“
<img loading=lazy src=/posts/golang/channel/001.png>
é¦–å…ˆä¸€ä¸ª<code>channel</code>éœ€è¦èƒ½æ”¯æŒå¤šä¸ª<code>goroutine</code>å¹¶å‘è®¿é—®ï¼Œè¿™éœ€è¦ä¸€æŠŠğŸ”’(<code>lock mutex</code>)</p><p>å¯¹äºæœ‰ç¼“å†²åŒºçš„<code>channel</code>è€Œè¨€ï¼Œéœ€è¦çŸ¥é“ç¼“å†²åŒºçš„ä½ç½®(<code>buf unsafe.Pointer</code>)ä»¥åŠç¼“å†²åŒºå†…æœ‰å¤šå°‘ä¸ªå…ƒç´ (<code>qcount unit</code>)ï¼Œæ¯ä¸ªå…ƒç´ å¤šå¤§(<code>datasiz uint</code>)ï¼Œæ‰€ä»¥ç¼“å†²åŒºå®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªæ•°ç»„</p><p>å› ä¸ºgolangè¿è¡Œæ—¶ä¸­å†…å­˜å¤åˆ¶ã€åƒåœ¾å›æ”¶ç­‰æœºåˆ¶ä¾èµ–æ•°æ®çš„ç±»å‹ä¿¡æ¯ï¼Œæ‰€ä»¥è¿˜éœ€è¦ä¸€ä¸ªæŒ‡é’ˆ(<code>elemtype *_type</code>)æŒ‡å‘æ•°æ®çš„ç±»å‹å…ƒæ•°æ®</p><p>ä¸ºäº†æ”¯æŒå®šæ—¶å™¨çš„åŠŸèƒ½æ·»åŠ äº†<code>timer *timer</code></p><p><code>channel</code>æ”¯æŒäº¤æ›¿çš„è¯»å†™ï¼Œéœ€è¦åˆ†åˆ«è®°å½•è¯»å’Œå†™ä¸‹æ ‡çš„ä½ç½®(<code>sendx uint recvx uint</code>)ï¼Œå½“è¯»å’Œå†™ä¸èƒ½ç«‹å³å®Œæˆçš„æ—¶å€™ï¼Œéœ€è¦èƒ½å¤Ÿè®©å½“å‰çš„<code>goroutine</code>åœ¨<code>channel</code>ä¸Šç­‰å¾…ï¼Œå½“æ¡ä»¶æ»¡è¶³æ—¶ï¼Œéœ€è¦å¯ä»¥ç«‹å³å”¤é†’ç­‰å¾…ä¸­çš„<code>goroutine</code>ï¼Œæ‰€æœ‰éœ€è¦ä¸¤ä¸ªç­‰å¾…é˜Ÿåˆ—æ¥é’ˆå¯¹è¯»å’Œå†™æ“ä½œ(<code>sendq waitq recvq waitq</code>)</p><p><code>channel</code>æ”¯æŒè¢«å…³é—­(<code>closed uint32</code>)</p><p>ç»¼ä¸Šæ‰€è¿°ï¼Œ<code>channel</code>çš„åº•å±‚æ•°æ®ç»“æ„å°±é•¿è¿™ä¸ªæ ·å­</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-1-1><a class=lnlinks href=#hl-1-1> 1</a>
</span><span class=lnt id=hl-1-2><a class=lnlinks href=#hl-1-2> 2</a>
</span><span class=lnt id=hl-1-3><a class=lnlinks href=#hl-1-3> 3</a>
</span><span class=lnt id=hl-1-4><a class=lnlinks href=#hl-1-4> 4</a>
</span><span class=lnt id=hl-1-5><a class=lnlinks href=#hl-1-5> 5</a>
</span><span class=lnt id=hl-1-6><a class=lnlinks href=#hl-1-6> 6</a>
</span><span class=lnt id=hl-1-7><a class=lnlinks href=#hl-1-7> 7</a>
</span><span class=lnt id=hl-1-8><a class=lnlinks href=#hl-1-8> 8</a>
</span><span class=lnt id=hl-1-9><a class=lnlinks href=#hl-1-9> 9</a>
</span><span class=lnt id=hl-1-10><a class=lnlinks href=#hl-1-10>10</a>
</span><span class=lnt id=hl-1-11><a class=lnlinks href=#hl-1-11>11</a>
</span><span class=lnt id=hl-1-12><a class=lnlinks href=#hl-1-12>12</a>
</span><span class=lnt id=hl-1-13><a class=lnlinks href=#hl-1-13>13</a>
</span><span class=lnt id=hl-1-14><a class=lnlinks href=#hl-1-14>14</a>
</span><span class=lnt id=hl-1-15><a class=lnlinks href=#hl-1-15>15</a>
</span><span class=lnt id=hl-1-16><a class=lnlinks href=#hl-1-16>16</a>
</span><span class=lnt id=hl-1-17><a class=lnlinks href=#hl-1-17>17</a>
</span><span class=lnt id=hl-1-18><a class=lnlinks href=#hl-1-18>18</a>
</span><span class=lnt id=hl-1-19><a class=lnlinks href=#hl-1-19>19</a>
</span><span class=lnt id=hl-1-20><a class=lnlinks href=#hl-1-20>20</a>
</span><span class=lnt id=hl-1-21><a class=lnlinks href=#hl-1-21>21</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>hchan</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>qcount</span>   <span class=kt>uint</span>           <span class=c1>// total data in the queue</span>
</span></span><span class=line><span class=cl>	<span class=nx>dataqsiz</span> <span class=kt>uint</span>           <span class=c1>// size of the circular queue</span>
</span></span><span class=line><span class=cl>	<span class=nx>buf</span>      <span class=nx>unsafe</span><span class=p>.</span><span class=nx>Pointer</span> <span class=c1>// points to an array of dataqsiz elements</span>
</span></span><span class=line><span class=cl>	<span class=nx>elemsize</span> <span class=kt>uint16</span>
</span></span><span class=line><span class=cl>	<span class=nx>closed</span>   <span class=kt>uint32</span>
</span></span><span class=line><span class=cl>	<span class=nx>timer</span>    <span class=o>*</span><span class=nx>timer</span> <span class=c1>// timer feeding this chan</span>
</span></span><span class=line><span class=cl>	<span class=nx>elemtype</span> <span class=o>*</span><span class=nx>_type</span> <span class=c1>// element type</span>
</span></span><span class=line><span class=cl>	<span class=nx>sendx</span>    <span class=kt>uint</span>   <span class=c1>// send index</span>
</span></span><span class=line><span class=cl>	<span class=nx>recvx</span>    <span class=kt>uint</span>   <span class=c1>// receive index</span>
</span></span><span class=line><span class=cl>	<span class=nx>recvq</span>    <span class=nx>waitq</span>  <span class=c1>// list of recv waiters</span>
</span></span><span class=line><span class=cl>	<span class=nx>sendq</span>    <span class=nx>waitq</span>  <span class=c1>// list of send waiters</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// lock protects all fields in hchan, as well as several</span>
</span></span><span class=line><span class=cl>	<span class=c1>// fields in sudogs blocked on this channel.</span>
</span></span><span class=line><span class=cl>	<span class=c1>//</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Do not change another G&#39;s status while holding this lock</span>
</span></span><span class=line><span class=cl>	<span class=c1>// (in particular, do not ready a G), as this can deadlock</span>
</span></span><span class=line><span class=cl>	<span class=c1>// with stack shrinking.</span>
</span></span><span class=line><span class=cl>	<span class=nx>lock</span> <span class=nx>mutex</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å½“æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæœ‰ç¼“å†²åŒºçš„<code>channel</code>çš„æ—¶å€™ï¼Œ<code>recvx</code>å’Œ<code>sendx</code>éƒ½ä¸º0,ä¸æ–­å¾€<code>channel</code>ä¸­å‘é€æ•°æ®çš„æ—¶å€™ï¼Œå› ä¸ºæ²¡æœ‰<code>goroutine</code>åœ¨ç­‰å¾…æ¥æ”¶æˆ–å‘é€æ•°æ®ï¼Œæ‰€ä»¥<code>send</code>ä¼šä¸æ–­å‘åç§»åŠ¨ï¼Œæœ€åç§»åŠ¨å›èµ·ç‚¹(<code>recvx = sendx</code>)ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™åˆ™è¡¨æ˜<code>channel</code>çš„ç¼“å†²åŒºæ»¡äº†ï¼Œå…¶å®<code>channel</code>çš„ç¼“å†²åŒºæ˜¯ä¸€ä¸ª<strong>ç¯å½¢é˜Ÿåˆ—</strong>ï¼Œä¹Ÿç§°ä¹‹ä¸º<strong>ç¯å½¢ç¼“å†²åŒº</strong></p><p>é‚£å¦‚æœå½“ç¼“å†²åŒºæ»¡äº†ä¹‹åï¼Œ<code>goroutine</code>è¿˜æƒ³å¾€<code>channel</code>ä¸­å‘é€æ•°æ®ï¼Œè¿™ä¸ªæ—¶å€™<code>goroutine</code>å°±ä¼šè¿›å…¥åˆ°å‘é€ç­‰å¾…é˜Ÿåˆ—<code>sendq</code>ï¼ˆè¿™æ˜¯ä¸€ä¸ª<code>sudog</code>ç±»å‹çš„é“¾è¡¨ï¼‰ï¼Œ<code>sudog</code>ä¸­çš„<code>g *g</code>å°±è®°å½•è¯¥<code>goroutine</code>çš„ä¿¡æ¯ï¼Œ<code>c *hchan</code>è®°å½•ç€åœ¨ç­‰å¾…å“ªä¸ª<code>channel</code>ï¼Œ<code>elem unsafe.Pointer</code>å­˜å‚¨ç€æ•°æ®æŒ‡é’ˆã€‚ä¸‹é¢æ˜¯æˆªå–çš„æºç æ³¨é‡Š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-2-1><a class=lnlinks href=#hl-2-1> 1</a>
</span><span class=lnt id=hl-2-2><a class=lnlinks href=#hl-2-2> 2</a>
</span><span class=lnt id=hl-2-3><a class=lnlinks href=#hl-2-3> 3</a>
</span><span class=lnt id=hl-2-4><a class=lnlinks href=#hl-2-4> 4</a>
</span><span class=lnt id=hl-2-5><a class=lnlinks href=#hl-2-5> 5</a>
</span><span class=lnt id=hl-2-6><a class=lnlinks href=#hl-2-6> 6</a>
</span><span class=lnt id=hl-2-7><a class=lnlinks href=#hl-2-7> 7</a>
</span><span class=lnt id=hl-2-8><a class=lnlinks href=#hl-2-8> 8</a>
</span><span class=lnt id=hl-2-9><a class=lnlinks href=#hl-2-9> 9</a>
</span><span class=lnt id=hl-2-10><a class=lnlinks href=#hl-2-10>10</a>
</span><span class=lnt id=hl-2-11><a class=lnlinks href=#hl-2-11>11</a>
</span><span class=lnt id=hl-2-12><a class=lnlinks href=#hl-2-12>12</a>
</span><span class=lnt id=hl-2-13><a class=lnlinks href=#hl-2-13>13</a>
</span><span class=lnt id=hl-2-14><a class=lnlinks href=#hl-2-14>14</a>
</span><span class=lnt id=hl-2-15><a class=lnlinks href=#hl-2-15>15</a>
</span><span class=lnt id=hl-2-16><a class=lnlinks href=#hl-2-16>16</a>
</span><span class=lnt id=hl-2-17><a class=lnlinks href=#hl-2-17>17</a>
</span><span class=lnt id=hl-2-18><a class=lnlinks href=#hl-2-18>18</a>
</span><span class=lnt id=hl-2-19><a class=lnlinks href=#hl-2-19>19</a>
</span><span class=lnt id=hl-2-20><a class=lnlinks href=#hl-2-20>20</a>
</span><span class=lnt id=hl-2-21><a class=lnlinks href=#hl-2-21>21</a>
</span><span class=lnt id=hl-2-22><a class=lnlinks href=#hl-2-22>22</a>
</span><span class=lnt id=hl-2-23><a class=lnlinks href=#hl-2-23>23</a>
</span><span class=lnt id=hl-2-24><a class=lnlinks href=#hl-2-24>24</a>
</span><span class=lnt id=hl-2-25><a class=lnlinks href=#hl-2-25>25</a>
</span><span class=lnt id=hl-2-26><a class=lnlinks href=#hl-2-26>26</a>
</span><span class=lnt id=hl-2-27><a class=lnlinks href=#hl-2-27>27</a>
</span><span class=lnt id=hl-2-28><a class=lnlinks href=#hl-2-28>28</a>
</span><span class=lnt id=hl-2-29><a class=lnlinks href=#hl-2-29>29</a>
</span><span class=lnt id=hl-2-30><a class=lnlinks href=#hl-2-30>30</a>
</span><span class=lnt id=hl-2-31><a class=lnlinks href=#hl-2-31>31</a>
</span><span class=lnt id=hl-2-32><a class=lnlinks href=#hl-2-32>32</a>
</span><span class=lnt id=hl-2-33><a class=lnlinks href=#hl-2-33>33</a>
</span><span class=lnt id=hl-2-34><a class=lnlinks href=#hl-2-34>34</a>
</span><span class=lnt id=hl-2-35><a class=lnlinks href=#hl-2-35>35</a>
</span><span class=lnt id=hl-2-36><a class=lnlinks href=#hl-2-36>36</a>
</span><span class=lnt id=hl-2-37><a class=lnlinks href=#hl-2-37>37</a>
</span><span class=lnt id=hl-2-38><a class=lnlinks href=#hl-2-38>38</a>
</span><span class=lnt id=hl-2-39><a class=lnlinks href=#hl-2-39>39</a>
</span><span class=lnt id=hl-2-40><a class=lnlinks href=#hl-2-40>40</a>
</span><span class=lnt id=hl-2-41><a class=lnlinks href=#hl-2-41>41</a>
</span><span class=lnt id=hl-2-42><a class=lnlinks href=#hl-2-42>42</a>
</span><span class=lnt id=hl-2-43><a class=lnlinks href=#hl-2-43>43</a>
</span><span class=lnt id=hl-2-44><a class=lnlinks href=#hl-2-44>44</a>
</span><span class=lnt id=hl-2-45><a class=lnlinks href=#hl-2-45>45</a>
</span><span class=lnt id=hl-2-46><a class=lnlinks href=#hl-2-46>46</a>
</span><span class=lnt id=hl-2-47><a class=lnlinks href=#hl-2-47>47</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>waitq</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>first</span> <span class=o>*</span><span class=nx>sudog</span>
</span></span><span class=line><span class=cl>	<span class=nx>last</span>  <span class=o>*</span><span class=nx>sudog</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>sudog</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// The following fields are protected by the hchan.lock of the</span>
</span></span><span class=line><span class=cl>	<span class=c1>// channel this sudog is blocking on. shrinkstack depends on</span>
</span></span><span class=line><span class=cl>	<span class=c1>// this for sudogs involved in channel ops.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>g</span> <span class=o>*</span><span class=nx>g</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>next</span> <span class=o>*</span><span class=nx>sudog</span>
</span></span><span class=line><span class=cl>	<span class=nx>prev</span> <span class=o>*</span><span class=nx>sudog</span>
</span></span><span class=line><span class=cl>	<span class=nx>elem</span> <span class=nx>unsafe</span><span class=p>.</span><span class=nx>Pointer</span> <span class=c1>// data element (may point to stack)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// The following fields are never accessed concurrently.</span>
</span></span><span class=line><span class=cl>	<span class=c1>// For channels, waitlink is only accessed by g.</span>
</span></span><span class=line><span class=cl>	<span class=c1>// For semaphores, all fields (including the ones above)</span>
</span></span><span class=line><span class=cl>	<span class=c1>// are only accessed when holding a semaRoot lock.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>acquiretime</span> <span class=kt>int64</span>
</span></span><span class=line><span class=cl>	<span class=nx>releasetime</span> <span class=kt>int64</span>
</span></span><span class=line><span class=cl>	<span class=nx>ticket</span>      <span class=kt>uint32</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// isSelect indicates g is participating in a select, so</span>
</span></span><span class=line><span class=cl>	<span class=c1>// g.selectDone must be CAS&#39;d to win the wake-up race.</span>
</span></span><span class=line><span class=cl>	<span class=nx>isSelect</span> <span class=kt>bool</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// success indicates whether communication over channel c</span>
</span></span><span class=line><span class=cl>	<span class=c1>// succeeded. It is true if the goroutine was awoken because a</span>
</span></span><span class=line><span class=cl>	<span class=c1>// value was delivered over channel c, and false if awoken</span>
</span></span><span class=line><span class=cl>	<span class=c1>// because c was closed.</span>
</span></span><span class=line><span class=cl>	<span class=nx>success</span> <span class=kt>bool</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// waiters is a count of semaRoot waiting list other than head of list,</span>
</span></span><span class=line><span class=cl>	<span class=c1>// clamped to a uint16 to fit in unused space.</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Only meaningful at the head of the list.</span>
</span></span><span class=line><span class=cl>	<span class=c1>// (If we wanted to be overly clever, we could store a high 16 bits</span>
</span></span><span class=line><span class=cl>	<span class=c1>// in the second entry in the list.)</span>
</span></span><span class=line><span class=cl>	<span class=nx>waiters</span> <span class=kt>uint16</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>parent</span>   <span class=o>*</span><span class=nx>sudog</span> <span class=c1>// semaRoot binary tree</span>
</span></span><span class=line><span class=cl>	<span class=nx>waitlink</span> <span class=o>*</span><span class=nx>sudog</span> <span class=c1>// g.waiting list or semaRoot</span>
</span></span><span class=line><span class=cl>	<span class=nx>waittail</span> <span class=o>*</span><span class=nx>sudog</span> <span class=c1>// semaRoot</span>
</span></span><span class=line><span class=cl>	<span class=nx>c</span>        <span class=o>*</span><span class=nx>hchan</span> <span class=c1>// channel</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>æ˜¾ç„¶ï¼Œå½“å¦å¤–ä¸€ä¸ª<code>goroutine</code>è¿›æ¥è¯»å–<code>channel</code>çš„æ•°æ®ï¼Œ<code>recvx</code>å‘åç§»åŠ¨ï¼Œç¼“å†²åŒºåˆæœ‰äº†ç©ºé—´ï¼Œè¿™æ—¶ä¼šå”¤é†’ç­‰å¾…é˜Ÿåˆ—ä¸­çš„<code>goroutine</code>ï¼Œè®©å…¶æ‰§è¡Œå†™å…¥æ•°æ®çš„æ“ä½œ</p><p>åˆ°è¿™é‡Œæˆ‘ä»¬å°±è®¤è¯†åˆ°äº†<code>channel</code>åº•å±‚çš„æ•°æ®ç»“æ„</p><h2 id=å‘é€æ•°æ®åˆ°channel>å‘é€æ•°æ®åˆ°channel<a hidden class=anchor aria-hidden=true href=#å‘é€æ•°æ®åˆ°channel>#</a></h2><p>å½“<code>channel</code>çš„ç¼“å†²åŒºæ»¡è¶³ä»¥ä¸‹æ¡ä»¶æ‰æ˜¯ä¸é˜»å¡çš„ï¼š</p><ul><li>ç¼“å†²åŒºè¿˜æœ‰ç©ºé—²ä½ç½®</li><li>æ¥æ”¶ç­‰å¾…é˜Ÿåˆ—ä¸­è¿˜æœ‰é˜»å¡ç­‰å¾…çš„<code>goroutine</code></li></ul><p><img loading=lazy src=/posts/golang/channel/002.png></p><p>ç›¸åï¼Œé˜»å¡çš„æ¡ä»¶åˆ™æ˜¯ï¼š</p><ul><li><code>channel</code>ä¸º<code>nil</code></li><li><code>channel</code>æ— ç¼“å†²åŒºä¸”æ¥æ”¶é˜Ÿåˆ—ä¸­æ²¡æœ‰é˜»å¡ç­‰å¾…çš„<code>goroutine</code></li><li>ç¼“å†²åŒºæ»¡äº†ä¸”æ¥æ”¶é˜Ÿåˆ—ä¸­æ²¡æœ‰é˜»å¡ç­‰å¾…çš„<code>goroutine</code></li></ul><p><img loading=lazy src=/posts/golang/channel/003.png></p><p>å› æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡è°ƒæ•´å†™ä»£ç çš„æ–¹å¼å°½é‡ä¸é˜»å¡</p><p>å…è®¸é˜»å¡å¼ä»£ç ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-3-1><a class=lnlinks href=#hl-3-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>ch</span> <span class=o>&lt;-</span> <span class=mi>10</span>
</span></span></code></pre></td></tr></table></div></div><p>éé˜»å¡å¼ä»£ç ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-4-1><a class=lnlinks href=#hl-4-1>1</a>
</span><span class=lnt id=hl-4-2><a class=lnlinks href=#hl-4-2>2</a>
</span><span class=lnt id=hl-4-3><a class=lnlinks href=#hl-4-3>3</a>
</span><span class=lnt id=hl-4-4><a class=lnlinks href=#hl-4-4>4</a>
</span><span class=lnt id=hl-4-5><a class=lnlinks href=#hl-4-5>5</a>
</span><span class=lnt id=hl-4-6><a class=lnlinks href=#hl-4-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=k>case</span> <span class=nx>ch</span> <span class=o>&lt;-</span> <span class=mi>10</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=k>default</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å¦‚æœä¸Šé¢çš„<code>case</code>é˜»å¡äº†ï¼Œå°±ä¼šè¿›å…¥åˆ°<code>default</code>åˆ†æ”¯å½“ä¸­</p><p>è¿™æ˜¯å‘é€æ•°æ®çš„å†™æ³•ï¼Œæ¥æ”¶æ•°æ®çš„å†™æ³•ä¼šæ›´å¤šä¸€ç‚¹</p><h2 id=ä»channelä¸­æ¥æ”¶æ•°æ®>ä»channelä¸­æ¥æ”¶æ•°æ®<a hidden class=anchor aria-hidden=true href=#ä»channelä¸­æ¥æ”¶æ•°æ®>#</a></h2><p>ä»<code>channel</code>ä¸­æ¥æ”¶æ•°æ®ä¸é˜»å¡ï¼š</p><ul><li>ç¼“å†²åŒºå­˜åœ¨æ•°æ®</li><li>æ²¡æœ‰ç¼“å†²åŒºä½†æ˜¯<code>sendq</code>ä¸­æœ‰é˜»å¡ç­‰å¾…å‘é€çš„<code>goroutine</code></li></ul><p>ç›¸åï¼Œé˜»å¡çš„æƒ…å†µä¸ºï¼š</p><ul><li><code>channel</code>ä¸º<code>nil</code></li><li>æ²¡æœ‰ç¼“å†²åŒºä¸”<code>sendq</code>ä¸­æ²¡æœ‰é˜»å¡ç­‰å¾…å‘é€çš„<code>goroutine</code></li><li>ç¼“å†²åŒºä¸ºç©ºä¸”<code>sendq</code>ä¸­æ²¡æœ‰é˜»å¡ç­‰å¾…å‘é€çš„<code>goroutine</code></li></ul><p>å…è®¸é˜»å¡å¼ä»£ç ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-5-1><a class=lnlinks href=#hl-5-1>1</a>
</span><span class=lnt id=hl-5-2><a class=lnlinks href=#hl-5-2>2</a>
</span><span class=lnt id=hl-5-3><a class=lnlinks href=#hl-5-3>3</a>
</span><span class=lnt id=hl-5-4><a class=lnlinks href=#hl-5-4>4</a>
</span><span class=lnt id=hl-5-5><a class=lnlinks href=#hl-5-5>5</a>
</span><span class=lnt id=hl-5-6><a class=lnlinks href=#hl-5-6>6</a>
</span><span class=lnt id=hl-5-7><a class=lnlinks href=#hl-5-7>7</a>
</span><span class=lnt id=hl-5-8><a class=lnlinks href=#hl-5-8>8</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// ä¸¢å¼ƒchä¸­æ¥æ”¶çš„æ•°æ®</span>
</span></span><span class=line><span class=cl><span class=o>&lt;-</span><span class=nx>ch</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// å°†æ¥æ”¶çš„æ•°æ®èµ‹å€¼ç»™v</span>
</span></span><span class=line><span class=cl><span class=nx>v</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>ch</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Comma-oké£æ ¼å†™æ³•</span>
</span></span><span class=line><span class=cl><span class=nx>v</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>ch</span>
</span></span></code></pre></td></tr></table></div></div><p>éé˜»å¡å¼ä»£ç ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-6-1><a class=lnlinks href=#hl-6-1>1</a>
</span><span class=lnt id=hl-6-2><a class=lnlinks href=#hl-6-2>2</a>
</span><span class=lnt id=hl-6-3><a class=lnlinks href=#hl-6-3>3</a>
</span><span class=lnt id=hl-6-4><a class=lnlinks href=#hl-6-4>4</a>
</span><span class=lnt id=hl-6-5><a class=lnlinks href=#hl-6-5>5</a>
</span><span class=lnt id=hl-6-6><a class=lnlinks href=#hl-6-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=k>case</span> <span class=o>&lt;-</span><span class=nx>ch</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=k>default</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>è¿™é‡Œçš„selectåªé’ˆå¯¹ä½†ä¸ª<code>channel</code>çš„æ“ä½œï¼Œå¤šè·¯selectåˆæœ‰æ‰€ä¸åŒ</p><h2 id=å¤šè·¯select>å¤šè·¯select<a hidden class=anchor aria-hidden=true href=#å¤šè·¯select>#</a></h2><p>å¤šè·¯selectæŒ‡çš„å­˜åœ¨ä¸¤ä¸ªæˆ–æ›´å¤šçš„caseåˆ†æ”¯ï¼Œæ¯ä¸ªåˆ†æ”¯å¯ä»¥æ˜¯ä¸€ä¸ª<code>channel</code>çš„<code>send</code>å’Œ<code>recv</code>æ“ä½œ</p><p>golangçš„selectè¯­å¥é‡‡ç”¨çš„æ˜¯å¤šè·¯å¤ç”¨çš„æ€æƒ³ï¼Œæœ¬è´¨ä¸Šæ˜¯ä¸ºäº†è¾¾åˆ°é€šè¿‡ä¸€ä¸ªåç¨‹åŒæ—¶å¤„ç†å¤šä¸ªIOè¯·æ±‚ï¼ˆChannelè¯»å†™äº‹ä»¶ï¼‰</p><p><img loading=lazy src=/posts/golang/channel/006.png></p><p>å¤šè·¯selectä¼šè¢«golangç¼–è¯‘å™¨è½¬åŒ–ä¸ºå¯¹<code>runtime.selectgo()</code>çš„å‡½æ•°è°ƒç”¨ï¼Œç”±äºè¯¥å‡½æ•°æºç æœ‰å››ç™¾å¤šè¡Œï¼Œé‚£æˆ‘ä»¬å…ˆä»å‡½æ•°çš„å…¥å‚å’Œå‡ºå‚çœ‹å§</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-7-1><a class=lnlinks href=#hl-7-1> 1</a>
</span><span class=lnt id=hl-7-2><a class=lnlinks href=#hl-7-2> 2</a>
</span><span class=lnt id=hl-7-3><a class=lnlinks href=#hl-7-3> 3</a>
</span><span class=lnt id=hl-7-4><a class=lnlinks href=#hl-7-4> 4</a>
</span><span class=lnt id=hl-7-5><a class=lnlinks href=#hl-7-5> 5</a>
</span><span class=lnt id=hl-7-6><a class=lnlinks href=#hl-7-6> 6</a>
</span><span class=lnt id=hl-7-7><a class=lnlinks href=#hl-7-7> 7</a>
</span><span class=lnt id=hl-7-8><a class=lnlinks href=#hl-7-8> 8</a>
</span><span class=lnt id=hl-7-9><a class=lnlinks href=#hl-7-9> 9</a>
</span><span class=lnt id=hl-7-10><a class=lnlinks href=#hl-7-10>10</a>
</span><span class=lnt id=hl-7-11><a class=lnlinks href=#hl-7-11>11</a>
</span><span class=lnt id=hl-7-12><a class=lnlinks href=#hl-7-12>12</a>
</span><span class=lnt id=hl-7-13><a class=lnlinks href=#hl-7-13>13</a>
</span><span class=lnt id=hl-7-14><a class=lnlinks href=#hl-7-14>14</a>
</span><span class=lnt id=hl-7-15><a class=lnlinks href=#hl-7-15>15</a>
</span><span class=lnt id=hl-7-16><a class=lnlinks href=#hl-7-16>16</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// selectgo implements the select statement.</span>
</span></span><span class=line><span class=cl><span class=c1>//</span>
</span></span><span class=line><span class=cl><span class=c1>// cas0 points to an array of type [ncases]scase, and order0 points to</span>
</span></span><span class=line><span class=cl><span class=c1>// an array of type [2*ncases]uint16 where ncases must be &lt;= 65536.</span>
</span></span><span class=line><span class=cl><span class=c1>// Both reside on the goroutine&#39;s stack (regardless of any escaping in</span>
</span></span><span class=line><span class=cl><span class=c1>// selectgo).</span>
</span></span><span class=line><span class=cl><span class=c1>//</span>
</span></span><span class=line><span class=cl><span class=c1>// For race detector builds, pc0 points to an array of type</span>
</span></span><span class=line><span class=cl><span class=c1>// [ncases]uintptr (also on the stack); for other builds, it&#39;s set to</span>
</span></span><span class=line><span class=cl><span class=c1>// nil.</span>
</span></span><span class=line><span class=cl><span class=c1>//</span>
</span></span><span class=line><span class=cl><span class=c1>// selectgo returns the index of the chosen scase, which matches the</span>
</span></span><span class=line><span class=cl><span class=c1>// ordinal position of its respective select{recv,send,default} call.</span>
</span></span><span class=line><span class=cl><span class=c1>// Also, if the chosen scase was a receive operation, it reports whether</span>
</span></span><span class=line><span class=cl><span class=c1>// a value was received.</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>selectgo</span><span class=p>(</span><span class=nx>cas0</span> <span class=o>*</span><span class=nx>scase</span><span class=p>,</span> <span class=nx>order0</span> <span class=o>*</span><span class=kt>uint16</span><span class=p>,</span> <span class=nx>pc0</span> <span class=o>*</span><span class=kt>uintptr</span><span class=p>,</span> <span class=nx>nsends</span><span class=p>,</span> <span class=nx>nrecvs</span> <span class=kt>int</span><span class=p>,</span> <span class=nx>block</span> <span class=kt>bool</span><span class=p>)</span> <span class=p>(</span><span class=kt>int</span><span class=p>,</span> <span class=kt>bool</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p><code>cas0 *scase</code>æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œç”¨äºå­˜å‚¨<code>select</code>çš„<code>case</code>åˆ†æ”¯</p><p><code>order0 *uint16</code>æŒ‡å‘çš„æ˜¯ä¸€ä¸ªç±»å‹ä¸º<code>uint16</code>çš„æ•°ç»„ï¼Œå…¶é•¿åº¦æ˜¯åˆ†æ”¯æ•°é‡çš„2å€ï¼Œå‰é¢ä¸€åŠç”¨äºå¯¹æ¯ä¸ª<code>channel</code>çš„ä¹±åºè½®è¯¢ï¼ˆä¿è¯å…¬å¹³æ€§ï¼‰ï¼Œåé¢ä¸€åŠç”¨äºæœ‰åºçš„å¯¹æ¯ä¸ª<code>channel</code>åŠ é”ï¼ˆåˆç†çš„åŠ é”é¡ºåºæ‰èƒ½é¿å…æ­»é”ï¼‰</p><p><code>pc0 *uintptr</code>ä¸golangçš„raceæ£€æµ‹ç›¸å…³ <a href=https://go.dev/blog/race-detector>race-detector</a>ï¼Œè¿™é‡Œä¸å±•å¼€è¯´</p><p><code>nsends, nrecvs int</code>åˆ†åˆ«è®°å½•ç”¨äº<code>send</code>å’Œ<code>recv</code>æ“ä½œçš„åˆ†æ”¯åˆ†åˆ«æœ‰å¤šå°‘ä¸ª</p><p><code>block bool</code>è¡¨ç¤ºæ˜¯å¦é˜»å¡ï¼Œå³æœ‰<code>default</code>ä¸º<code>false</code>ï¼Œåä¹‹ä¸º<code>true</code></p><p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹æ‰§è¡Œè¿‡ç¨‹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-8-1><a class=lnlinks href=#hl-8-1> 1</a>
</span><span class=lnt id=hl-8-2><a class=lnlinks href=#hl-8-2> 2</a>
</span><span class=lnt id=hl-8-3><a class=lnlinks href=#hl-8-3> 3</a>
</span><span class=lnt id=hl-8-4><a class=lnlinks href=#hl-8-4> 4</a>
</span><span class=lnt id=hl-8-5><a class=lnlinks href=#hl-8-5> 5</a>
</span><span class=lnt id=hl-8-6><a class=lnlinks href=#hl-8-6> 6</a>
</span><span class=lnt id=hl-8-7><a class=lnlinks href=#hl-8-7> 7</a>
</span><span class=lnt id=hl-8-8><a class=lnlinks href=#hl-8-8> 8</a>
</span><span class=lnt id=hl-8-9><a class=lnlinks href=#hl-8-9> 9</a>
</span><span class=lnt id=hl-8-10><a class=lnlinks href=#hl-8-10>10</a>
</span><span class=lnt id=hl-8-11><a class=lnlinks href=#hl-8-11>11</a>
</span><span class=lnt id=hl-8-12><a class=lnlinks href=#hl-8-12>12</a>
</span><span class=lnt id=hl-8-13><a class=lnlinks href=#hl-8-13>13</a>
</span><span class=lnt id=hl-8-14><a class=lnlinks href=#hl-8-14>14</a>
</span><span class=lnt id=hl-8-15><a class=lnlinks href=#hl-8-15>15</a>
</span><span class=lnt id=hl-8-16><a class=lnlinks href=#hl-8-16>16</a>
</span><span class=lnt id=hl-8-17><a class=lnlinks href=#hl-8-17>17</a>
</span><span class=lnt id=hl-8-18><a class=lnlinks href=#hl-8-18>18</a>
</span><span class=lnt id=hl-8-19><a class=lnlinks href=#hl-8-19>19</a>
</span><span class=lnt id=hl-8-20><a class=lnlinks href=#hl-8-20>20</a>
</span><span class=lnt id=hl-8-21><a class=lnlinks href=#hl-8-21>21</a>
</span><span class=lnt id=hl-8-22><a class=lnlinks href=#hl-8-22>22</a>
</span><span class=lnt id=hl-8-23><a class=lnlinks href=#hl-8-23>23</a>
</span><span class=lnt id=hl-8-24><a class=lnlinks href=#hl-8-24>24</a>
</span><span class=lnt id=hl-8-25><a class=lnlinks href=#hl-8-25>25</a>
</span><span class=lnt id=hl-8-26><a class=lnlinks href=#hl-8-26>26</a>
</span><span class=lnt id=hl-8-27><a class=lnlinks href=#hl-8-27>27</a>
</span><span class=lnt id=hl-8-28><a class=lnlinks href=#hl-8-28>28</a>
</span><span class=lnt id=hl-8-29><a class=lnlinks href=#hl-8-29>29</a>
</span><span class=lnt id=hl-8-30><a class=lnlinks href=#hl-8-30>30</a>
</span><span class=lnt id=hl-8-31><a class=lnlinks href=#hl-8-31>31</a>
</span><span class=lnt id=hl-8-32><a class=lnlinks href=#hl-8-32>32</a>
</span><span class=lnt id=hl-8-33><a class=lnlinks href=#hl-8-33>33</a>
</span><span class=lnt id=hl-8-34><a class=lnlinks href=#hl-8-34>34</a>
</span><span class=lnt id=hl-8-35><a class=lnlinks href=#hl-8-35>35</a>
</span><span class=lnt id=hl-8-36><a class=lnlinks href=#hl-8-36>36</a>
</span><span class=lnt id=hl-8-37><a class=lnlinks href=#hl-8-37>37</a>
</span><span class=lnt id=hl-8-38><a class=lnlinks href=#hl-8-38>38</a>
</span><span class=lnt id=hl-8-39><a class=lnlinks href=#hl-8-39>39</a>
</span><span class=lnt id=hl-8-40><a class=lnlinks href=#hl-8-40>40</a>
</span><span class=lnt id=hl-8-41><a class=lnlinks href=#hl-8-41>41</a>
</span><span class=lnt id=hl-8-42><a class=lnlinks href=#hl-8-42>42</a>
</span><span class=lnt id=hl-8-43><a class=lnlinks href=#hl-8-43>43</a>
</span><span class=lnt id=hl-8-44><a class=lnlinks href=#hl-8-44>44</a>
</span><span class=lnt id=hl-8-45><a class=lnlinks href=#hl-8-45>45</a>
</span><span class=lnt id=hl-8-46><a class=lnlinks href=#hl-8-46>46</a>
</span><span class=lnt id=hl-8-47><a class=lnlinks href=#hl-8-47>47</a>
</span><span class=lnt id=hl-8-48><a class=lnlinks href=#hl-8-48>48</a>
</span><span class=lnt id=hl-8-49><a class=lnlinks href=#hl-8-49>49</a>
</span><span class=lnt id=hl-8-50><a class=lnlinks href=#hl-8-50>50</a>
</span><span class=lnt id=hl-8-51><a class=lnlinks href=#hl-8-51>51</a>
</span><span class=lnt id=hl-8-52><a class=lnlinks href=#hl-8-52>52</a>
</span><span class=lnt id=hl-8-53><a class=lnlinks href=#hl-8-53>53</a>
</span><span class=lnt id=hl-8-54><a class=lnlinks href=#hl-8-54>54</a>
</span><span class=lnt id=hl-8-55><a class=lnlinks href=#hl-8-55>55</a>
</span><span class=lnt id=hl-8-56><a class=lnlinks href=#hl-8-56>56</a>
</span><span class=lnt id=hl-8-57><a class=lnlinks href=#hl-8-57>57</a>
</span><span class=lnt id=hl-8-58><a class=lnlinks href=#hl-8-58>58</a>
</span><span class=lnt id=hl-8-59><a class=lnlinks href=#hl-8-59>59</a>
</span><span class=lnt id=hl-8-60><a class=lnlinks href=#hl-8-60>60</a>
</span><span class=lnt id=hl-8-61><a class=lnlinks href=#hl-8-61>61</a>
</span><span class=lnt id=hl-8-62><a class=lnlinks href=#hl-8-62>62</a>
</span><span class=lnt id=hl-8-63><a class=lnlinks href=#hl-8-63>63</a>
</span><span class=lnt id=hl-8-64><a class=lnlinks href=#hl-8-64>64</a>
</span><span class=lnt id=hl-8-65><a class=lnlinks href=#hl-8-65>65</a>
</span><span class=lnt id=hl-8-66><a class=lnlinks href=#hl-8-66>66</a>
</span><span class=lnt id=hl-8-67><a class=lnlinks href=#hl-8-67>67</a>
</span><span class=lnt id=hl-8-68><a class=lnlinks href=#hl-8-68>68</a>
</span><span class=lnt id=hl-8-69><a class=lnlinks href=#hl-8-69>69</a>
</span><span class=lnt id=hl-8-70><a class=lnlinks href=#hl-8-70>70</a>
</span><span class=lnt id=hl-8-71><a class=lnlinks href=#hl-8-71>71</a>
</span><span class=lnt id=hl-8-72><a class=lnlinks href=#hl-8-72>72</a>
</span><span class=lnt id=hl-8-73><a class=lnlinks href=#hl-8-73>73</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>selectgo</span><span class=p>(</span><span class=nx>cas0</span> <span class=o>*</span><span class=nx>scase</span><span class=p>,</span> <span class=nx>order0</span> <span class=o>*</span><span class=kt>uint16</span><span class=p>,</span> <span class=nx>pc0</span> <span class=o>*</span><span class=kt>uintptr</span><span class=p>,</span> <span class=nx>nsends</span><span class=p>,</span> <span class=nx>nrecvs</span> <span class=kt>int</span><span class=p>,</span> <span class=nx>block</span> <span class=kt>bool</span><span class=p>)</span> <span class=p>(</span><span class=kt>int</span><span class=p>,</span> <span class=kt>bool</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=o>......</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ä¸ºäº†å°†scaseåˆ†é…åˆ°æ ˆä¸Šï¼Œè¿™é‡Œç›´æ¥ç»™cas1åˆ†é…äº†64KBå¤§å°çš„æ•°ç»„ï¼ŒåŒç†ï¼Œ ç»™order1åˆ†é…äº†128KBå¤§å°çš„æ•°ç»„</span>
</span></span><span class=line><span class=cl>  <span class=nx>cas1</span> <span class=o>:=</span> <span class=p>(</span><span class=o>*</span><span class=p>[</span><span class=mi>1</span> <span class=o>&lt;&lt;</span> <span class=mi>16</span><span class=p>]</span><span class=nx>scase</span><span class=p>)(</span><span class=nx>unsafe</span><span class=p>.</span><span class=nf>Pointer</span><span class=p>(</span><span class=nx>cas0</span><span class=p>))</span>
</span></span><span class=line><span class=cl>  <span class=nx>order1</span> <span class=o>:=</span> <span class=p>(</span><span class=o>*</span><span class=p>[</span><span class=mi>1</span> <span class=o>&lt;&lt;</span> <span class=mi>17</span><span class=p>]</span><span class=kt>uint16</span><span class=p>)(</span><span class=nx>unsafe</span><span class=p>.</span><span class=nf>Pointer</span><span class=p>(</span><span class=nx>order0</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// ncasesä¸ªæ•°æ˜¯å‘é€chanä¸ªæ•°nsendsåŠ ä¸Šæ¥æ”¶chanä¸ªæ•°nrecvs</span>
</span></span><span class=line><span class=cl>  <span class=nx>ncases</span> <span class=o>:=</span> <span class=nx>nsends</span> <span class=o>+</span> <span class=nx>nrecvs</span>
</span></span><span class=line><span class=cl>  <span class=c1>// scasesåˆ‡ç‰‡æ˜¯ä¸Šé¢åˆ†é…cas1æ•°ç»„çš„å‰ncasesä¸ªå…ƒç´ </span>
</span></span><span class=line><span class=cl>  <span class=nx>scases</span> <span class=o>:=</span> <span class=nx>cas1</span><span class=p>[:</span><span class=nx>ncases</span><span class=p>:</span><span class=nx>ncases</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=c1>// é¡ºåºåˆ—è¡¨pollorderæ˜¯order1æ•°ç»„çš„å‰ncasesä¸ªå…ƒç´ </span>
</span></span><span class=line><span class=cl>  <span class=nx>pollorder</span> <span class=o>:=</span> <span class=nx>order1</span><span class=p>[:</span><span class=nx>ncases</span><span class=p>:</span><span class=nx>ncases</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=c1>// åŠ é”åˆ—è¡¨lockorderæ˜¯order1æ•°ç»„çš„ç¬¬äºŒæ‰¹ncaseä¸ªå…ƒç´ </span>
</span></span><span class=line><span class=cl>  <span class=c1>// æ‰€ä»¥è¯´order0æŒ‡å‘çš„æ•°ç»„æ˜¯caseæ•°é‡çš„ä¸¤å€ï¼Œåˆ†æˆå‰ä¸€åŠå’Œåä¸€åŠä½¿ç”¨</span>
</span></span><span class=line><span class=cl>  <span class=nx>lockorder</span> <span class=o>:=</span> <span class=nx>order1</span><span class=p>[</span><span class=nx>ncases</span><span class=p>:][:</span><span class=nx>ncases</span><span class=p>:</span><span class=nx>ncases</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=o>......</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// ç”Ÿæˆæ’åˆ—é¡ºåºï¼ˆé¿å… channel çš„é¥¥é¥¿é—®é¢˜ï¼Œä¿è¯å…¬å¹³æ€§ï¼‰</span>
</span></span><span class=line><span class=cl>  <span class=nx>norder</span> <span class=o>:=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>scases</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>cas</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>scases</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// å¤„ç†caseä¸­channelä¸ºç©ºçš„æƒ…å†µ</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>cas</span><span class=p>.</span><span class=nx>c</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>cas</span><span class=p>.</span><span class=nx>elem</span> <span class=p>=</span> <span class=kc>nil</span> <span class=c1>// å°†elemç½®ç©ºï¼Œä¾¿äºGC</span>
</span></span><span class=line><span class=cl>      <span class=k>continue</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// é€šè¿‡fastrandnå‡½æ•°å¼•å…¥éšæœºæ€§ï¼Œç¡®å®špollorderåˆ—è¡¨ä¸­caseçš„éšæœºé¡ºåºç´¢å¼•</span>
</span></span><span class=line><span class=cl>    <span class=nx>j</span> <span class=o>:=</span> <span class=nf>fastrandn</span><span class=p>(</span><span class=nb>uint32</span><span class=p>(</span><span class=nx>norder</span> <span class=o>+</span> <span class=mi>1</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=nx>pollorder</span><span class=p>[</span><span class=nx>norder</span><span class=p>]</span> <span class=p>=</span> <span class=nx>pollorder</span><span class=p>[</span><span class=nx>j</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=nx>pollorder</span><span class=p>[</span><span class=nx>j</span><span class=p>]</span> <span class=p>=</span> <span class=nb>uint16</span><span class=p>(</span><span class=nx>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>norder</span><span class=o>++</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>pollorder</span> <span class=p>=</span> <span class=nx>pollorder</span><span class=p>[:</span><span class=nx>norder</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=nx>lockorder</span> <span class=p>=</span> <span class=nx>lockorder</span><span class=p>[:</span><span class=nx>norder</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// æ ¹æ®chanåœ°å€ç¡®å®šlockorderåŠ é”æ’åºåˆ—è¡¨çš„é¡ºåº</span>
</span></span><span class=line><span class=cl>  <span class=c1>// é€šè¿‡ç®€å•çš„å †æ’åºï¼Œä»¥nlognæ—¶é—´å¤æ‚åº¦å®Œæˆæ’åº</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>lockorder</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>j</span> <span class=o>:=</span> <span class=nx>i</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Start with the pollorder to permute cases on the same channel.</span>
</span></span><span class=line><span class=cl>    <span class=nx>c</span> <span class=o>:=</span> <span class=nx>scases</span><span class=p>[</span><span class=nx>pollorder</span><span class=p>[</span><span class=nx>i</span><span class=p>]].</span><span class=nx>c</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=nx>j</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=nx>scases</span><span class=p>[</span><span class=nx>lockorder</span><span class=p>[(</span><span class=nx>j</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span><span class=o>/</span><span class=mi>2</span><span class=p>]].</span><span class=nx>c</span><span class=p>.</span><span class=nf>sortkey</span><span class=p>()</span> <span class=p>&lt;</span> <span class=nx>c</span><span class=p>.</span><span class=nf>sortkey</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>k</span> <span class=o>:=</span> <span class=p>(</span><span class=nx>j</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span> <span class=o>/</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>      <span class=nx>lockorder</span><span class=p>[</span><span class=nx>j</span><span class=p>]</span> <span class=p>=</span> <span class=nx>lockorder</span><span class=p>[</span><span class=nx>k</span><span class=p>]</span>
</span></span><span class=line><span class=cl>      <span class=nx>j</span> <span class=p>=</span> <span class=nx>k</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>lockorder</span><span class=p>[</span><span class=nx>j</span><span class=p>]</span> <span class=p>=</span> <span class=nx>pollorder</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=nb>len</span><span class=p>(</span><span class=nx>lockorder</span><span class=p>)</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&gt;=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span><span class=o>--</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>o</span> <span class=o>:=</span> <span class=nx>lockorder</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=nx>c</span> <span class=o>:=</span> <span class=nx>scases</span><span class=p>[</span><span class=nx>o</span><span class=p>].</span><span class=nx>c</span>
</span></span><span class=line><span class=cl>    <span class=nx>lockorder</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=p>=</span> <span class=nx>lockorder</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=nx>j</span> <span class=o>:=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>k</span> <span class=o>:=</span> <span class=nx>j</span><span class=o>*</span><span class=mi>2</span> <span class=o>+</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=nx>k</span> <span class=o>&gt;=</span> <span class=nx>i</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=nx>k</span><span class=o>+</span><span class=mi>1</span> <span class=p>&lt;</span> <span class=nx>i</span> <span class=o>&amp;&amp;</span> <span class=nx>scases</span><span class=p>[</span><span class=nx>lockorder</span><span class=p>[</span><span class=nx>k</span><span class=p>]].</span><span class=nx>c</span><span class=p>.</span><span class=nf>sortkey</span><span class=p>()</span> <span class=p>&lt;</span> <span class=nx>scases</span><span class=p>[</span><span class=nx>lockorder</span><span class=p>[</span><span class=nx>k</span><span class=o>+</span><span class=mi>1</span><span class=p>]].</span><span class=nx>c</span><span class=p>.</span><span class=nf>sortkey</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>k</span><span class=o>++</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=nx>c</span><span class=p>.</span><span class=nf>sortkey</span><span class=p>()</span> <span class=p>&lt;</span> <span class=nx>scases</span><span class=p>[</span><span class=nx>lockorder</span><span class=p>[</span><span class=nx>k</span><span class=p>]].</span><span class=nx>c</span><span class=p>.</span><span class=nf>sortkey</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>lockorder</span><span class=p>[</span><span class=nx>j</span><span class=p>]</span> <span class=p>=</span> <span class=nx>lockorder</span><span class=p>[</span><span class=nx>k</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=nx>j</span> <span class=p>=</span> <span class=nx>k</span>
</span></span><span class=line><span class=cl>        <span class=k>continue</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>break</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>lockorder</span><span class=p>[</span><span class=nx>j</span><span class=p>]</span> <span class=p>=</span> <span class=nx>o</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=o>......</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>åŠ é”å’Œè§£é”è°ƒç”¨çš„æ˜¯<code>runtime.sellock()</code>å‡½æ•°å’Œ<code>runtime.selunlock()</code>å‡½æ•°ã€‚ä»ä¸‹é¢çš„ä»£ç é€»è¾‘ä¸­å¯ä»¥çœ‹åˆ°ï¼Œä¸¤ä¸ªå‡½æ•°åˆ†åˆ«æ˜¯æŒ‰<code>lockorder</code>é¡ºåºå¯¹<code>channel</code>åŠ é”ï¼Œä»¥åŠæŒ‰<code>lockorder</code>é€†åºé‡Šæ”¾é”ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-9-1><a class=lnlinks href=#hl-9-1> 1</a>
</span><span class=lnt id=hl-9-2><a class=lnlinks href=#hl-9-2> 2</a>
</span><span class=lnt id=hl-9-3><a class=lnlinks href=#hl-9-3> 3</a>
</span><span class=lnt id=hl-9-4><a class=lnlinks href=#hl-9-4> 4</a>
</span><span class=lnt id=hl-9-5><a class=lnlinks href=#hl-9-5> 5</a>
</span><span class=lnt id=hl-9-6><a class=lnlinks href=#hl-9-6> 6</a>
</span><span class=lnt id=hl-9-7><a class=lnlinks href=#hl-9-7> 7</a>
</span><span class=lnt id=hl-9-8><a class=lnlinks href=#hl-9-8> 8</a>
</span><span class=lnt id=hl-9-9><a class=lnlinks href=#hl-9-9> 9</a>
</span><span class=lnt id=hl-9-10><a class=lnlinks href=#hl-9-10>10</a>
</span><span class=lnt id=hl-9-11><a class=lnlinks href=#hl-9-11>11</a>
</span><span class=lnt id=hl-9-12><a class=lnlinks href=#hl-9-12>12</a>
</span><span class=lnt id=hl-9-13><a class=lnlinks href=#hl-9-13>13</a>
</span><span class=lnt id=hl-9-14><a class=lnlinks href=#hl-9-14>14</a>
</span><span class=lnt id=hl-9-15><a class=lnlinks href=#hl-9-15>15</a>
</span><span class=lnt id=hl-9-16><a class=lnlinks href=#hl-9-16>16</a>
</span><span class=lnt id=hl-9-17><a class=lnlinks href=#hl-9-17>17</a>
</span><span class=lnt id=hl-9-18><a class=lnlinks href=#hl-9-18>18</a>
</span><span class=lnt id=hl-9-19><a class=lnlinks href=#hl-9-19>19</a>
</span><span class=lnt id=hl-9-20><a class=lnlinks href=#hl-9-20>20</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>sellock</span><span class=p>(</span><span class=nx>scases</span> <span class=p>[]</span><span class=nx>scase</span><span class=p>,</span> <span class=nx>lockorder</span> <span class=p>[]</span><span class=kt>uint16</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>var</span> <span class=nx>c</span> <span class=o>*</span><span class=nx>hchan</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>o</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>lockorder</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>c0</span> <span class=o>:=</span> <span class=nx>scases</span><span class=p>[</span><span class=nx>o</span><span class=p>].</span><span class=nx>c</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>c0</span> <span class=o>!=</span> <span class=nx>c</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>c</span> <span class=p>=</span> <span class=nx>c0</span>
</span></span><span class=line><span class=cl>      <span class=nf>lock</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>c</span><span class=p>.</span><span class=nx>lock</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>selunlock</span><span class=p>(</span><span class=nx>scases</span> <span class=p>[]</span><span class=nx>scase</span><span class=p>,</span> <span class=nx>lockorder</span> <span class=p>[]</span><span class=kt>uint16</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=nb>len</span><span class=p>(</span><span class=nx>lockorder</span><span class=p>)</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&gt;=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span><span class=o>--</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>c</span> <span class=o>:=</span> <span class=nx>scases</span><span class=p>[</span><span class=nx>lockorder</span><span class=p>[</span><span class=nx>i</span><span class=p>]].</span><span class=nx>c</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>i</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=nx>c</span> <span class=o>==</span> <span class=nx>scases</span><span class=p>[</span><span class=nx>lockorder</span><span class=p>[</span><span class=nx>i</span><span class=o>-</span><span class=mi>1</span><span class=p>]].</span><span class=nx>c</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>continue</span> 
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nf>unlock</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>c</span><span class=p>.</span><span class=nx>lock</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>æ¥ä¸‹æ¥å°±æ˜¯<code>selectgo</code>çš„ä¸»é€»è¾‘å•¦ï¼ˆå¥½é•¿ğŸ˜­ï¼‰</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-10-1><a class=lnlinks href=#hl-10-1>  1</a>
</span><span class=lnt id=hl-10-2><a class=lnlinks href=#hl-10-2>  2</a>
</span><span class=lnt id=hl-10-3><a class=lnlinks href=#hl-10-3>  3</a>
</span><span class=lnt id=hl-10-4><a class=lnlinks href=#hl-10-4>  4</a>
</span><span class=lnt id=hl-10-5><a class=lnlinks href=#hl-10-5>  5</a>
</span><span class=lnt id=hl-10-6><a class=lnlinks href=#hl-10-6>  6</a>
</span><span class=lnt id=hl-10-7><a class=lnlinks href=#hl-10-7>  7</a>
</span><span class=lnt id=hl-10-8><a class=lnlinks href=#hl-10-8>  8</a>
</span><span class=lnt id=hl-10-9><a class=lnlinks href=#hl-10-9>  9</a>
</span><span class=lnt id=hl-10-10><a class=lnlinks href=#hl-10-10> 10</a>
</span><span class=lnt id=hl-10-11><a class=lnlinks href=#hl-10-11> 11</a>
</span><span class=lnt id=hl-10-12><a class=lnlinks href=#hl-10-12> 12</a>
</span><span class=lnt id=hl-10-13><a class=lnlinks href=#hl-10-13> 13</a>
</span><span class=lnt id=hl-10-14><a class=lnlinks href=#hl-10-14> 14</a>
</span><span class=lnt id=hl-10-15><a class=lnlinks href=#hl-10-15> 15</a>
</span><span class=lnt id=hl-10-16><a class=lnlinks href=#hl-10-16> 16</a>
</span><span class=lnt id=hl-10-17><a class=lnlinks href=#hl-10-17> 17</a>
</span><span class=lnt id=hl-10-18><a class=lnlinks href=#hl-10-18> 18</a>
</span><span class=lnt id=hl-10-19><a class=lnlinks href=#hl-10-19> 19</a>
</span><span class=lnt id=hl-10-20><a class=lnlinks href=#hl-10-20> 20</a>
</span><span class=lnt id=hl-10-21><a class=lnlinks href=#hl-10-21> 21</a>
</span><span class=lnt id=hl-10-22><a class=lnlinks href=#hl-10-22> 22</a>
</span><span class=lnt id=hl-10-23><a class=lnlinks href=#hl-10-23> 23</a>
</span><span class=lnt id=hl-10-24><a class=lnlinks href=#hl-10-24> 24</a>
</span><span class=lnt id=hl-10-25><a class=lnlinks href=#hl-10-25> 25</a>
</span><span class=lnt id=hl-10-26><a class=lnlinks href=#hl-10-26> 26</a>
</span><span class=lnt id=hl-10-27><a class=lnlinks href=#hl-10-27> 27</a>
</span><span class=lnt id=hl-10-28><a class=lnlinks href=#hl-10-28> 28</a>
</span><span class=lnt id=hl-10-29><a class=lnlinks href=#hl-10-29> 29</a>
</span><span class=lnt id=hl-10-30><a class=lnlinks href=#hl-10-30> 30</a>
</span><span class=lnt id=hl-10-31><a class=lnlinks href=#hl-10-31> 31</a>
</span><span class=lnt id=hl-10-32><a class=lnlinks href=#hl-10-32> 32</a>
</span><span class=lnt id=hl-10-33><a class=lnlinks href=#hl-10-33> 33</a>
</span><span class=lnt id=hl-10-34><a class=lnlinks href=#hl-10-34> 34</a>
</span><span class=lnt id=hl-10-35><a class=lnlinks href=#hl-10-35> 35</a>
</span><span class=lnt id=hl-10-36><a class=lnlinks href=#hl-10-36> 36</a>
</span><span class=lnt id=hl-10-37><a class=lnlinks href=#hl-10-37> 37</a>
</span><span class=lnt id=hl-10-38><a class=lnlinks href=#hl-10-38> 38</a>
</span><span class=lnt id=hl-10-39><a class=lnlinks href=#hl-10-39> 39</a>
</span><span class=lnt id=hl-10-40><a class=lnlinks href=#hl-10-40> 40</a>
</span><span class=lnt id=hl-10-41><a class=lnlinks href=#hl-10-41> 41</a>
</span><span class=lnt id=hl-10-42><a class=lnlinks href=#hl-10-42> 42</a>
</span><span class=lnt id=hl-10-43><a class=lnlinks href=#hl-10-43> 43</a>
</span><span class=lnt id=hl-10-44><a class=lnlinks href=#hl-10-44> 44</a>
</span><span class=lnt id=hl-10-45><a class=lnlinks href=#hl-10-45> 45</a>
</span><span class=lnt id=hl-10-46><a class=lnlinks href=#hl-10-46> 46</a>
</span><span class=lnt id=hl-10-47><a class=lnlinks href=#hl-10-47> 47</a>
</span><span class=lnt id=hl-10-48><a class=lnlinks href=#hl-10-48> 48</a>
</span><span class=lnt id=hl-10-49><a class=lnlinks href=#hl-10-49> 49</a>
</span><span class=lnt id=hl-10-50><a class=lnlinks href=#hl-10-50> 50</a>
</span><span class=lnt id=hl-10-51><a class=lnlinks href=#hl-10-51> 51</a>
</span><span class=lnt id=hl-10-52><a class=lnlinks href=#hl-10-52> 52</a>
</span><span class=lnt id=hl-10-53><a class=lnlinks href=#hl-10-53> 53</a>
</span><span class=lnt id=hl-10-54><a class=lnlinks href=#hl-10-54> 54</a>
</span><span class=lnt id=hl-10-55><a class=lnlinks href=#hl-10-55> 55</a>
</span><span class=lnt id=hl-10-56><a class=lnlinks href=#hl-10-56> 56</a>
</span><span class=lnt id=hl-10-57><a class=lnlinks href=#hl-10-57> 57</a>
</span><span class=lnt id=hl-10-58><a class=lnlinks href=#hl-10-58> 58</a>
</span><span class=lnt id=hl-10-59><a class=lnlinks href=#hl-10-59> 59</a>
</span><span class=lnt id=hl-10-60><a class=lnlinks href=#hl-10-60> 60</a>
</span><span class=lnt id=hl-10-61><a class=lnlinks href=#hl-10-61> 61</a>
</span><span class=lnt id=hl-10-62><a class=lnlinks href=#hl-10-62> 62</a>
</span><span class=lnt id=hl-10-63><a class=lnlinks href=#hl-10-63> 63</a>
</span><span class=lnt id=hl-10-64><a class=lnlinks href=#hl-10-64> 64</a>
</span><span class=lnt id=hl-10-65><a class=lnlinks href=#hl-10-65> 65</a>
</span><span class=lnt id=hl-10-66><a class=lnlinks href=#hl-10-66> 66</a>
</span><span class=lnt id=hl-10-67><a class=lnlinks href=#hl-10-67> 67</a>
</span><span class=lnt id=hl-10-68><a class=lnlinks href=#hl-10-68> 68</a>
</span><span class=lnt id=hl-10-69><a class=lnlinks href=#hl-10-69> 69</a>
</span><span class=lnt id=hl-10-70><a class=lnlinks href=#hl-10-70> 70</a>
</span><span class=lnt id=hl-10-71><a class=lnlinks href=#hl-10-71> 71</a>
</span><span class=lnt id=hl-10-72><a class=lnlinks href=#hl-10-72> 72</a>
</span><span class=lnt id=hl-10-73><a class=lnlinks href=#hl-10-73> 73</a>
</span><span class=lnt id=hl-10-74><a class=lnlinks href=#hl-10-74> 74</a>
</span><span class=lnt id=hl-10-75><a class=lnlinks href=#hl-10-75> 75</a>
</span><span class=lnt id=hl-10-76><a class=lnlinks href=#hl-10-76> 76</a>
</span><span class=lnt id=hl-10-77><a class=lnlinks href=#hl-10-77> 77</a>
</span><span class=lnt id=hl-10-78><a class=lnlinks href=#hl-10-78> 78</a>
</span><span class=lnt id=hl-10-79><a class=lnlinks href=#hl-10-79> 79</a>
</span><span class=lnt id=hl-10-80><a class=lnlinks href=#hl-10-80> 80</a>
</span><span class=lnt id=hl-10-81><a class=lnlinks href=#hl-10-81> 81</a>
</span><span class=lnt id=hl-10-82><a class=lnlinks href=#hl-10-82> 82</a>
</span><span class=lnt id=hl-10-83><a class=lnlinks href=#hl-10-83> 83</a>
</span><span class=lnt id=hl-10-84><a class=lnlinks href=#hl-10-84> 84</a>
</span><span class=lnt id=hl-10-85><a class=lnlinks href=#hl-10-85> 85</a>
</span><span class=lnt id=hl-10-86><a class=lnlinks href=#hl-10-86> 86</a>
</span><span class=lnt id=hl-10-87><a class=lnlinks href=#hl-10-87> 87</a>
</span><span class=lnt id=hl-10-88><a class=lnlinks href=#hl-10-88> 88</a>
</span><span class=lnt id=hl-10-89><a class=lnlinks href=#hl-10-89> 89</a>
</span><span class=lnt id=hl-10-90><a class=lnlinks href=#hl-10-90> 90</a>
</span><span class=lnt id=hl-10-91><a class=lnlinks href=#hl-10-91> 91</a>
</span><span class=lnt id=hl-10-92><a class=lnlinks href=#hl-10-92> 92</a>
</span><span class=lnt id=hl-10-93><a class=lnlinks href=#hl-10-93> 93</a>
</span><span class=lnt id=hl-10-94><a class=lnlinks href=#hl-10-94> 94</a>
</span><span class=lnt id=hl-10-95><a class=lnlinks href=#hl-10-95> 95</a>
</span><span class=lnt id=hl-10-96><a class=lnlinks href=#hl-10-96> 96</a>
</span><span class=lnt id=hl-10-97><a class=lnlinks href=#hl-10-97> 97</a>
</span><span class=lnt id=hl-10-98><a class=lnlinks href=#hl-10-98> 98</a>
</span><span class=lnt id=hl-10-99><a class=lnlinks href=#hl-10-99> 99</a>
</span><span class=lnt id=hl-10-100><a class=lnlinks href=#hl-10-100>100</a>
</span><span class=lnt id=hl-10-101><a class=lnlinks href=#hl-10-101>101</a>
</span><span class=lnt id=hl-10-102><a class=lnlinks href=#hl-10-102>102</a>
</span><span class=lnt id=hl-10-103><a class=lnlinks href=#hl-10-103>103</a>
</span><span class=lnt id=hl-10-104><a class=lnlinks href=#hl-10-104>104</a>
</span><span class=lnt id=hl-10-105><a class=lnlinks href=#hl-10-105>105</a>
</span><span class=lnt id=hl-10-106><a class=lnlinks href=#hl-10-106>106</a>
</span><span class=lnt id=hl-10-107><a class=lnlinks href=#hl-10-107>107</a>
</span><span class=lnt id=hl-10-108><a class=lnlinks href=#hl-10-108>108</a>
</span><span class=lnt id=hl-10-109><a class=lnlinks href=#hl-10-109>109</a>
</span><span class=lnt id=hl-10-110><a class=lnlinks href=#hl-10-110>110</a>
</span><span class=lnt id=hl-10-111><a class=lnlinks href=#hl-10-111>111</a>
</span><span class=lnt id=hl-10-112><a class=lnlinks href=#hl-10-112>112</a>
</span><span class=lnt id=hl-10-113><a class=lnlinks href=#hl-10-113>113</a>
</span><span class=lnt id=hl-10-114><a class=lnlinks href=#hl-10-114>114</a>
</span><span class=lnt id=hl-10-115><a class=lnlinks href=#hl-10-115>115</a>
</span><span class=lnt id=hl-10-116><a class=lnlinks href=#hl-10-116>116</a>
</span><span class=lnt id=hl-10-117><a class=lnlinks href=#hl-10-117>117</a>
</span><span class=lnt id=hl-10-118><a class=lnlinks href=#hl-10-118>118</a>
</span><span class=lnt id=hl-10-119><a class=lnlinks href=#hl-10-119>119</a>
</span><span class=lnt id=hl-10-120><a class=lnlinks href=#hl-10-120>120</a>
</span><span class=lnt id=hl-10-121><a class=lnlinks href=#hl-10-121>121</a>
</span><span class=lnt id=hl-10-122><a class=lnlinks href=#hl-10-122>122</a>
</span><span class=lnt id=hl-10-123><a class=lnlinks href=#hl-10-123>123</a>
</span><span class=lnt id=hl-10-124><a class=lnlinks href=#hl-10-124>124</a>
</span><span class=lnt id=hl-10-125><a class=lnlinks href=#hl-10-125>125</a>
</span><span class=lnt id=hl-10-126><a class=lnlinks href=#hl-10-126>126</a>
</span><span class=lnt id=hl-10-127><a class=lnlinks href=#hl-10-127>127</a>
</span><span class=lnt id=hl-10-128><a class=lnlinks href=#hl-10-128>128</a>
</span><span class=lnt id=hl-10-129><a class=lnlinks href=#hl-10-129>129</a>
</span><span class=lnt id=hl-10-130><a class=lnlinks href=#hl-10-130>130</a>
</span><span class=lnt id=hl-10-131><a class=lnlinks href=#hl-10-131>131</a>
</span><span class=lnt id=hl-10-132><a class=lnlinks href=#hl-10-132>132</a>
</span><span class=lnt id=hl-10-133><a class=lnlinks href=#hl-10-133>133</a>
</span><span class=lnt id=hl-10-134><a class=lnlinks href=#hl-10-134>134</a>
</span><span class=lnt id=hl-10-135><a class=lnlinks href=#hl-10-135>135</a>
</span><span class=lnt id=hl-10-136><a class=lnlinks href=#hl-10-136>136</a>
</span><span class=lnt id=hl-10-137><a class=lnlinks href=#hl-10-137>137</a>
</span><span class=lnt id=hl-10-138><a class=lnlinks href=#hl-10-138>138</a>
</span><span class=lnt id=hl-10-139><a class=lnlinks href=#hl-10-139>139</a>
</span><span class=lnt id=hl-10-140><a class=lnlinks href=#hl-10-140>140</a>
</span><span class=lnt id=hl-10-141><a class=lnlinks href=#hl-10-141>141</a>
</span><span class=lnt id=hl-10-142><a class=lnlinks href=#hl-10-142>142</a>
</span><span class=lnt id=hl-10-143><a class=lnlinks href=#hl-10-143>143</a>
</span><span class=lnt id=hl-10-144><a class=lnlinks href=#hl-10-144>144</a>
</span><span class=lnt id=hl-10-145><a class=lnlinks href=#hl-10-145>145</a>
</span><span class=lnt id=hl-10-146><a class=lnlinks href=#hl-10-146>146</a>
</span><span class=lnt id=hl-10-147><a class=lnlinks href=#hl-10-147>147</a>
</span><span class=lnt id=hl-10-148><a class=lnlinks href=#hl-10-148>148</a>
</span><span class=lnt id=hl-10-149><a class=lnlinks href=#hl-10-149>149</a>
</span><span class=lnt id=hl-10-150><a class=lnlinks href=#hl-10-150>150</a>
</span><span class=lnt id=hl-10-151><a class=lnlinks href=#hl-10-151>151</a>
</span><span class=lnt id=hl-10-152><a class=lnlinks href=#hl-10-152>152</a>
</span><span class=lnt id=hl-10-153><a class=lnlinks href=#hl-10-153>153</a>
</span><span class=lnt id=hl-10-154><a class=lnlinks href=#hl-10-154>154</a>
</span><span class=lnt id=hl-10-155><a class=lnlinks href=#hl-10-155>155</a>
</span><span class=lnt id=hl-10-156><a class=lnlinks href=#hl-10-156>156</a>
</span><span class=lnt id=hl-10-157><a class=lnlinks href=#hl-10-157>157</a>
</span><span class=lnt id=hl-10-158><a class=lnlinks href=#hl-10-158>158</a>
</span><span class=lnt id=hl-10-159><a class=lnlinks href=#hl-10-159>159</a>
</span><span class=lnt id=hl-10-160><a class=lnlinks href=#hl-10-160>160</a>
</span><span class=lnt id=hl-10-161><a class=lnlinks href=#hl-10-161>161</a>
</span><span class=lnt id=hl-10-162><a class=lnlinks href=#hl-10-162>162</a>
</span><span class=lnt id=hl-10-163><a class=lnlinks href=#hl-10-163>163</a>
</span><span class=lnt id=hl-10-164><a class=lnlinks href=#hl-10-164>164</a>
</span><span class=lnt id=hl-10-165><a class=lnlinks href=#hl-10-165>165</a>
</span><span class=lnt id=hl-10-166><a class=lnlinks href=#hl-10-166>166</a>
</span><span class=lnt id=hl-10-167><a class=lnlinks href=#hl-10-167>167</a>
</span><span class=lnt id=hl-10-168><a class=lnlinks href=#hl-10-168>168</a>
</span><span class=lnt id=hl-10-169><a class=lnlinks href=#hl-10-169>169</a>
</span><span class=lnt id=hl-10-170><a class=lnlinks href=#hl-10-170>170</a>
</span><span class=lnt id=hl-10-171><a class=lnlinks href=#hl-10-171>171</a>
</span><span class=lnt id=hl-10-172><a class=lnlinks href=#hl-10-172>172</a>
</span><span class=lnt id=hl-10-173><a class=lnlinks href=#hl-10-173>173</a>
</span><span class=lnt id=hl-10-174><a class=lnlinks href=#hl-10-174>174</a>
</span><span class=lnt id=hl-10-175><a class=lnlinks href=#hl-10-175>175</a>
</span><span class=lnt id=hl-10-176><a class=lnlinks href=#hl-10-176>176</a>
</span><span class=lnt id=hl-10-177><a class=lnlinks href=#hl-10-177>177</a>
</span><span class=lnt id=hl-10-178><a class=lnlinks href=#hl-10-178>178</a>
</span><span class=lnt id=hl-10-179><a class=lnlinks href=#hl-10-179>179</a>
</span><span class=lnt id=hl-10-180><a class=lnlinks href=#hl-10-180>180</a>
</span><span class=lnt id=hl-10-181><a class=lnlinks href=#hl-10-181>181</a>
</span><span class=lnt id=hl-10-182><a class=lnlinks href=#hl-10-182>182</a>
</span><span class=lnt id=hl-10-183><a class=lnlinks href=#hl-10-183>183</a>
</span><span class=lnt id=hl-10-184><a class=lnlinks href=#hl-10-184>184</a>
</span><span class=lnt id=hl-10-185><a class=lnlinks href=#hl-10-185>185</a>
</span><span class=lnt id=hl-10-186><a class=lnlinks href=#hl-10-186>186</a>
</span><span class=lnt id=hl-10-187><a class=lnlinks href=#hl-10-187>187</a>
</span><span class=lnt id=hl-10-188><a class=lnlinks href=#hl-10-188>188</a>
</span><span class=lnt id=hl-10-189><a class=lnlinks href=#hl-10-189>189</a>
</span><span class=lnt id=hl-10-190><a class=lnlinks href=#hl-10-190>190</a>
</span><span class=lnt id=hl-10-191><a class=lnlinks href=#hl-10-191>191</a>
</span><span class=lnt id=hl-10-192><a class=lnlinks href=#hl-10-192>192</a>
</span><span class=lnt id=hl-10-193><a class=lnlinks href=#hl-10-193>193</a>
</span><span class=lnt id=hl-10-194><a class=lnlinks href=#hl-10-194>194</a>
</span><span class=lnt id=hl-10-195><a class=lnlinks href=#hl-10-195>195</a>
</span><span class=lnt id=hl-10-196><a class=lnlinks href=#hl-10-196>196</a>
</span><span class=lnt id=hl-10-197><a class=lnlinks href=#hl-10-197>197</a>
</span><span class=lnt id=hl-10-198><a class=lnlinks href=#hl-10-198>198</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>selectgo</span><span class=p>(</span><span class=nx>cas0</span> <span class=o>*</span><span class=nx>scase</span><span class=p>,</span> <span class=nx>order0</span> <span class=o>*</span><span class=kt>uint16</span><span class=p>,</span> <span class=nx>pc0</span> <span class=o>*</span><span class=kt>uintptr</span><span class=p>,</span> <span class=nx>nsends</span><span class=p>,</span> <span class=nx>nrecvs</span> <span class=kt>int</span><span class=p>,</span> <span class=nx>block</span> <span class=kt>bool</span><span class=p>)</span> <span class=p>(</span><span class=kt>int</span><span class=p>,</span> <span class=kt>bool</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=o>......</span>
</span></span><span class=line><span class=cl>  <span class=nf>sellock</span><span class=p>(</span><span class=nx>scases</span><span class=p>,</span> <span class=nx>lockorder</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=o>......</span>
</span></span><span class=line><span class=cl>  <span class=c1>// é˜¶æ®µä¸€: æŸ¥æ‰¾å¯ä»¥å¤„ç†çš„channel</span>
</span></span><span class=line><span class=cl>  <span class=kd>var</span> <span class=nx>casi</span> <span class=kt>int</span>
</span></span><span class=line><span class=cl>  <span class=kd>var</span> <span class=nx>cas</span> <span class=o>*</span><span class=nx>scase</span>
</span></span><span class=line><span class=cl>  <span class=kd>var</span> <span class=nx>caseSuccess</span> <span class=kt>bool</span>
</span></span><span class=line><span class=cl>  <span class=kd>var</span> <span class=nx>caseReleaseTime</span> <span class=kt>int64</span> <span class=p>=</span> <span class=o>-</span><span class=mi>1</span>
</span></span><span class=line><span class=cl>  <span class=kd>var</span> <span class=nx>recvOK</span> <span class=kt>bool</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>casei</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>pollorder</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>casi</span> <span class=p>=</span> <span class=nb>int</span><span class=p>(</span><span class=nx>casei</span><span class=p>)</span>      <span class=c1>// caseçš„ç´¢å¼•</span>
</span></span><span class=line><span class=cl>    <span class=nx>cas</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>scases</span><span class=p>[</span><span class=nx>casi</span><span class=p>]</span>    <span class=c1>// å½“å‰çš„case</span>
</span></span><span class=line><span class=cl>    <span class=nx>c</span> <span class=p>=</span> <span class=nx>cas</span><span class=p>.</span><span class=nx>c</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>casi</span> <span class=o>&gt;=</span> <span class=nx>nsends</span> <span class=p>{</span> <span class=c1>// å¤„ç†æ¥æ”¶channelçš„case</span>
</span></span><span class=line><span class=cl>      <span class=nx>sg</span> <span class=p>=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>sendq</span><span class=p>.</span><span class=nf>dequeue</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=c1>// å¦‚æœå½“å‰channelçš„sendqä¸Šæœ‰ç­‰å¾…çš„goroutineï¼Œå°±ä¼šè·³åˆ° recvæ ‡ç­¾å¹¶ä»ç¼“å†²åŒºè¯»å–æ•°æ®åå°†ç­‰å¾…goroutineä¸­çš„æ•°æ®æ”¾å…¥åˆ°ç¼“å†²åŒºä¸­ç›¸åŒçš„ä½ç½®ï¼›</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=nx>sg</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>        <span class=k>goto</span> <span class=nx>recv</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=nx>c</span><span class=p>.</span><span class=nx>qcount</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=p>{</span> <span class=c1>//å¦‚æœå½“å‰channelçš„ç¼“å†²åŒºä¸ä¸ºç©ºï¼Œå°±ä¼šè·³åˆ°bufrecvæ ‡ç­¾å¤„ä»ç¼“å†²åŒºè·å–æ•°æ®ï¼›</span>
</span></span><span class=line><span class=cl>        <span class=k>goto</span> <span class=nx>bufrecv</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=nx>c</span><span class=p>.</span><span class=nx>closed</span> <span class=o>!=</span> <span class=mi>0</span> <span class=p>{</span>  <span class=c1>//å¦‚æœå½“å‰channelå·²ç»è¢«å…³é—­ï¼Œå°±ä¼šè·³åˆ°rcloseåšä¸€äº›æ¸…é™¤çš„æ”¶å°¾å·¥ä½œï¼›</span>
</span></span><span class=line><span class=cl>        <span class=k>goto</span> <span class=nx>rclose</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>                      <span class=c1>// å¤„ç†å‘é€channelçš„case</span>
</span></span><span class=line><span class=cl>      <span class=o>......</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=nx>c</span><span class=p>.</span><span class=nx>closed</span> <span class=o>!=</span> <span class=mi>0</span> <span class=p>{</span> <span class=c1>// å¦‚æœå½“å‰channelå·²ç»è¢«å…³é—­å°±ä¼šç›´æ¥è·³åˆ°scloseæ ‡ç­¾ï¼Œè§¦å‘ panic å°è¯•ä¸­æ­¢ç¨‹åºï¼›</span>
</span></span><span class=line><span class=cl>        <span class=k>goto</span> <span class=nx>sclose</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=nx>sg</span> <span class=p>=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>recvq</span><span class=p>.</span><span class=nf>dequeue</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=nx>sg</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>  <span class=c1>// å¦‚æœå½“å‰channelçš„recvqä¸Šæœ‰ç­‰å¾…çš„goroutineï¼Œå°±ä¼šè·³åˆ° sendæ ‡ç­¾å‘channelå‘é€æ•°æ®ï¼›</span>
</span></span><span class=line><span class=cl>        <span class=k>goto</span> <span class=nx>send</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=nx>c</span><span class=p>.</span><span class=nx>qcount</span> <span class=p>&lt;</span> <span class=nx>c</span><span class=p>.</span><span class=nx>dataqsiz</span> <span class=p>{</span> <span class=c1>// å¦‚æœå½“å‰channelçš„ç¼“å†²åŒºå­˜åœ¨ç©ºé—²ä½ç½®ï¼Œå°±ä¼šå°†å¾…å‘é€çš„æ•°æ®å­˜å…¥ç¼“å†²åŒºï¼›</span>
</span></span><span class=line><span class=cl>        <span class=k>goto</span> <span class=nx>bufsend</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>!</span><span class=nx>block</span> <span class=p>{</span>  <span class=c1>// å¦‚æœæ˜¯éé˜»å¡ï¼Œå³åŒ…å«defaultåˆ†æ”¯ï¼Œä¼šè§£é”æ‰€æœ‰ Channel å¹¶è¿”å›</span>
</span></span><span class=line><span class=cl>       <span class=nf>selunlock</span><span class=p>(</span><span class=nx>scases</span><span class=p>,</span> <span class=nx>lockorder</span><span class=p>)</span>
</span></span><span class=line><span class=cl>       <span class=nx>casi</span> <span class=p>=</span> <span class=o>-</span><span class=mi>1</span>
</span></span><span class=line><span class=cl>       <span class=k>goto</span> <span class=nx>retc</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>      
</span></span><span class=line><span class=cl>  <span class=c1>// é˜¶æ®µ2: å°†å½“å‰goroutineæ ¹æ®éœ€è¦æŒ‚åœ¨chançš„sendqå’Œrecvqä¸Š</span>
</span></span><span class=line><span class=cl>  <span class=nx>gp</span> <span class=p>=</span> <span class=nf>getg</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nx>gp</span><span class=p>.</span><span class=nx>waiting</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>throw</span><span class=p>(</span><span class=s>&#34;gp.waiting != nil&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>nextp</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>gp</span><span class=p>.</span><span class=nx>waiting</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>casei</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>lockorder</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>    <span class=nx>casi</span> <span class=p>=</span> <span class=nb>int</span><span class=p>(</span><span class=nx>casei</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>cas</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>scases</span><span class=p>[</span><span class=nx>casi</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=nx>c</span> <span class=p>=</span> <span class=nx>cas</span><span class=p>.</span><span class=nx>c</span>
</span></span><span class=line><span class=cl>    <span class=c1>// è·å–sudogï¼Œå°†å½“å‰goroutineç»‘å®šåˆ°sudogä¸Š</span>
</span></span><span class=line><span class=cl>    <span class=nx>sg</span> <span class=o>:=</span> <span class=nf>acquireSudog</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>sg</span><span class=p>.</span><span class=nx>g</span> <span class=p>=</span> <span class=nx>gp</span>
</span></span><span class=line><span class=cl>    <span class=nx>sg</span><span class=p>.</span><span class=nx>isSelect</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>    <span class=nx>sg</span><span class=p>.</span><span class=nx>elem</span> <span class=p>=</span> <span class=nx>cas</span><span class=p>.</span><span class=nx>elem</span>
</span></span><span class=line><span class=cl>    <span class=nx>sg</span><span class=p>.</span><span class=nx>releasetime</span> <span class=p>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>t0</span> <span class=o>!=</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>sg</span><span class=p>.</span><span class=nx>releasetime</span> <span class=p>=</span> <span class=o>-</span><span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>sg</span><span class=p>.</span><span class=nx>c</span> <span class=p>=</span> <span class=nx>c</span>
</span></span><span class=line><span class=cl>    <span class=o>*</span><span class=nx>nextp</span> <span class=p>=</span> <span class=nx>sg</span>
</span></span><span class=line><span class=cl>    <span class=nx>nextp</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>sg</span><span class=p>.</span><span class=nx>waitlink</span>
</span></span><span class=line><span class=cl>    <span class=c1>// åŠ å…¥ç›¸åº”ç­‰å¾…é˜Ÿåˆ—</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>casi</span> <span class=p>&lt;</span> <span class=nx>nsends</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>c</span><span class=p>.</span><span class=nx>sendq</span><span class=p>.</span><span class=nf>enqueue</span><span class=p>(</span><span class=nx>sg</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>c</span><span class=p>.</span><span class=nx>recvq</span><span class=p>.</span><span class=nf>enqueue</span><span class=p>(</span><span class=nx>sg</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  		<span class=o>......</span>
</span></span><span class=line><span class=cl>  <span class=c1>// è¢«å”¤é†’åä¼šæ ¹æ® param æ¥åˆ¤æ–­æ˜¯å¦æ˜¯ç”± close æ“ä½œå”¤é†’çš„ï¼Œæ‰€ä»¥å…ˆç½®ä¸º nil</span>
</span></span><span class=line><span class=cl>  <span class=nx>gp</span><span class=p>.</span><span class=nx>param</span> <span class=p>=</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>  		<span class=o>......</span>
</span></span><span class=line><span class=cl>  <span class=c1>// æŒ‚èµ·å½“å‰goroutine</span>
</span></span><span class=line><span class=cl>  <span class=nf>gopark</span><span class=p>(</span><span class=nx>selparkcommit</span><span class=p>,</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>waitReasonSelect</span><span class=p>,</span> <span class=nx>traceEvGoBlockSelect</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=c1>// åŠ é”æ‰€æœ‰çš„channel</span>
</span></span><span class=line><span class=cl>  <span class=nf>sellock</span><span class=p>(</span><span class=nx>scases</span><span class=p>,</span> <span class=nx>lockorder</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>gp</span><span class=p>.</span><span class=nx>selectDone</span> <span class=p>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>  <span class=c1>// param å­˜æ”¾å”¤é†’ goroutine çš„ sudogï¼Œå¦‚æœæ˜¯å…³é—­æ“ä½œå”¤é†’çš„ï¼Œé‚£ä¹ˆå°±ä¸º nil</span>
</span></span><span class=line><span class=cl>  <span class=nx>sg</span> <span class=p>=</span> <span class=p>(</span><span class=o>*</span><span class=nx>sudog</span><span class=p>)(</span><span class=nx>gp</span><span class=p>.</span><span class=nx>param</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>gp</span><span class=p>.</span><span class=nx>param</span> <span class=p>=</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>casi</span> <span class=p>=</span> <span class=o>-</span><span class=mi>1</span>
</span></span><span class=line><span class=cl>  <span class=nx>cas</span> <span class=p>=</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>  <span class=nx>caseSuccess</span> <span class=p>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>  <span class=c1>// å½“å‰goroutine çš„ waiting é“¾è¡¨æŒ‰ç…§lockorderé¡ºåºå­˜æ”¾ç€caseçš„sudog</span>
</span></span><span class=line><span class=cl>  <span class=nx>sglist</span> <span class=p>=</span> <span class=nx>gp</span><span class=p>.</span><span class=nx>waiting</span>
</span></span><span class=line><span class=cl>  <span class=c1>// åœ¨ä» gp.waiting å–æ¶ˆcaseçš„sudogé“¾æ¥ä¹‹å‰æ¸…é™¤æ‰€æœ‰å…ƒç´ ï¼Œä¾¿äºGC</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=nx>sg1</span> <span class=o>:=</span> <span class=nx>gp</span><span class=p>.</span><span class=nx>waiting</span><span class=p>;</span> <span class=nx>sg1</span> <span class=o>!=</span> <span class=kc>nil</span><span class=p>;</span> <span class=nx>sg1</span> <span class=p>=</span> <span class=nx>sg1</span><span class=p>.</span><span class=nx>waitlink</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>sg1</span><span class=p>.</span><span class=nx>isSelect</span> <span class=p>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>    <span class=nx>sg1</span><span class=p>.</span><span class=nx>elem</span> <span class=p>=</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>    <span class=nx>sg1</span><span class=p>.</span><span class=nx>c</span> <span class=p>=</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=c1>// æ¸…æ¥šå½“å‰goroutineçš„waitingé“¾è¡¨ï¼Œå› ä¸ºè¢«sgä»£è¡¨çš„åç¨‹å”¤é†’äº†</span>
</span></span><span class=line><span class=cl>  <span class=nx>gp</span><span class=p>.</span><span class=nx>waiting</span> <span class=p>=</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>casei</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>lockorder</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>k</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>scases</span><span class=p>[</span><span class=nx>casei</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=c1>// å¦‚æœç›¸ç­‰è¯´æ˜ï¼Œgoroutineæ˜¯è¢«å½“å‰caseçš„channelæ”¶å‘æ“ä½œå”¤é†’çš„</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>sg</span> <span class=o>==</span> <span class=nx>sglist</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// sgå”¤é†’äº†å½“å‰goroutine, åˆ™å½“å‰Gå·²ç»ä»sgçš„é˜Ÿåˆ—ä¸­å‡ºé˜Ÿï¼Œè¿™é‡Œä¸éœ€è¦å†æ¬¡å‡ºé˜Ÿ</span>
</span></span><span class=line><span class=cl>      <span class=nx>casi</span> <span class=p>=</span> <span class=nb>int</span><span class=p>(</span><span class=nx>casei</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=nx>cas</span> <span class=p>=</span> <span class=nx>k</span>
</span></span><span class=line><span class=cl>      <span class=nx>caseSuccess</span> <span class=p>=</span> <span class=nx>sglist</span><span class=p>.</span><span class=nx>success</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=nx>sglist</span><span class=p>.</span><span class=nx>releasetime</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>caseReleaseTime</span> <span class=p>=</span> <span class=nx>sglist</span><span class=p>.</span><span class=nx>releasetime</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// ä¸æ˜¯æ­¤caseå”¤é†’å½“å‰goroutine, å°†goroutineä»æ­¤caseçš„å‘é€é˜Ÿåˆ—æˆ–æ¥æ”¶é˜Ÿåˆ—å‡ºé˜Ÿ</span>
</span></span><span class=line><span class=cl>      <span class=nx>c</span> <span class=p>=</span> <span class=nx>k</span><span class=p>.</span><span class=nx>c</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=nb>int</span><span class=p>(</span><span class=nx>casei</span><span class=p>)</span> <span class=p>&lt;</span> <span class=nx>nsends</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>c</span><span class=p>.</span><span class=nx>sendq</span><span class=p>.</span><span class=nf>dequeueSudoG</span><span class=p>(</span><span class=nx>sglist</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>c</span><span class=p>.</span><span class=nx>recvq</span><span class=p>.</span><span class=nf>dequeueSudoG</span><span class=p>(</span><span class=nx>sglist</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// é‡Šæ”¾å½“å‰caseçš„sudogï¼Œç„¶åå¤„ç†ä¸‹ä¸€ä¸ªcaseçš„sudog</span>
</span></span><span class=line><span class=cl>    <span class=nx>sgnext</span> <span class=p>=</span> <span class=nx>sglist</span><span class=p>.</span><span class=nx>waitlink</span>
</span></span><span class=line><span class=cl>    <span class=nx>sglist</span><span class=p>.</span><span class=nx>waitlink</span> <span class=p>=</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>    <span class=nf>releaseSudog</span><span class=p>(</span><span class=nx>sglist</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>sglist</span> <span class=p>=</span> <span class=nx>sgnext</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// æœ€åçš„ä»£ç æ˜¯å¾ªç¯ç¬¬ä¸€é˜¶æ®µç”¨åˆ°çš„è·³è½¬æ ‡ç­¾ä»£ç æ®µ</span>
</span></span><span class=line><span class=cl><span class=nx>bufrecv</span><span class=p>:</span>
</span></span><span class=line><span class=cl>  <span class=o>......</span>
</span></span><span class=line><span class=cl>  <span class=nx>recvOK</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>  <span class=nx>qp</span> <span class=p>=</span> <span class=nf>chanbuf</span><span class=p>(</span><span class=nx>c</span><span class=p>,</span> <span class=nx>c</span><span class=p>.</span><span class=nx>recvx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nx>cas</span><span class=p>.</span><span class=nx>elem</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>typedmemmove</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>elemtype</span><span class=p>,</span> <span class=nx>cas</span><span class=p>.</span><span class=nx>elem</span><span class=p>,</span> <span class=nx>qp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nf>typedmemclr</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>elemtype</span><span class=p>,</span> <span class=nx>qp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>c</span><span class=p>.</span><span class=nx>recvx</span><span class=o>++</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nx>c</span><span class=p>.</span><span class=nx>recvx</span> <span class=o>==</span> <span class=nx>c</span><span class=p>.</span><span class=nx>dataqsiz</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>c</span><span class=p>.</span><span class=nx>recvx</span> <span class=p>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>c</span><span class=p>.</span><span class=nx>qcount</span><span class=o>--</span>
</span></span><span class=line><span class=cl>  <span class=nf>selunlock</span><span class=p>(</span><span class=nx>scases</span><span class=p>,</span> <span class=nx>lockorder</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>goto</span> <span class=nx>retc</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>bufsend</span><span class=p>:</span>
</span></span><span class=line><span class=cl>  <span class=o>......</span>
</span></span><span class=line><span class=cl>  <span class=nf>typedmemmove</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>elemtype</span><span class=p>,</span> <span class=nf>chanbuf</span><span class=p>(</span><span class=nx>c</span><span class=p>,</span> <span class=nx>c</span><span class=p>.</span><span class=nx>sendx</span><span class=p>),</span> <span class=nx>cas</span><span class=p>.</span><span class=nx>elem</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>c</span><span class=p>.</span><span class=nx>sendx</span><span class=o>++</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nx>c</span><span class=p>.</span><span class=nx>sendx</span> <span class=o>==</span> <span class=nx>c</span><span class=p>.</span><span class=nx>dataqsiz</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>c</span><span class=p>.</span><span class=nx>sendx</span> <span class=p>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>c</span><span class=p>.</span><span class=nx>qcount</span><span class=o>++</span>
</span></span><span class=line><span class=cl>  <span class=nf>selunlock</span><span class=p>(</span><span class=nx>scases</span><span class=p>,</span> <span class=nx>lockorder</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>goto</span> <span class=nx>retc</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>recv</span><span class=p>:</span>
</span></span><span class=line><span class=cl>  <span class=c1>// å¯ä»¥ç›´æ¥ä»ä¼‘çœ çš„goroutineè·å–æ•°æ®</span>
</span></span><span class=line><span class=cl>  <span class=nf>recv</span><span class=p>(</span><span class=nx>c</span><span class=p>,</span> <span class=nx>sg</span><span class=p>,</span> <span class=nx>cas</span><span class=p>.</span><span class=nx>elem</span><span class=p>,</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span> <span class=nf>selunlock</span><span class=p>(</span><span class=nx>scases</span><span class=p>,</span> <span class=nx>lockorder</span><span class=p>)</span> <span class=p>},</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=o>......</span>
</span></span><span class=line><span class=cl>  <span class=nx>recvOK</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>  <span class=k>goto</span> <span class=nx>retc</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>rclose</span><span class=p>:</span>
</span></span><span class=line><span class=cl>  <span class=c1>//ä»ä¸€ä¸ªå…³é—­ channel ä¸­æ¥æ”¶æ•°æ®ä¼šç›´æ¥æ¸…é™¤ Channel ä¸­çš„ç›¸å…³å†…å®¹ï¼›</span>
</span></span><span class=line><span class=cl>  <span class=nf>selunlock</span><span class=p>(</span><span class=nx>scases</span><span class=p>,</span> <span class=nx>lockorder</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>recvOK</span> <span class=p>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nx>cas</span><span class=p>.</span><span class=nx>elem</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>typedmemclr</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>elemtype</span><span class=p>,</span> <span class=nx>cas</span><span class=p>.</span><span class=nx>elem</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=o>......</span>
</span></span><span class=line><span class=cl>  <span class=k>goto</span> <span class=nx>retc</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>send</span><span class=p>:</span>
</span></span><span class=line><span class=cl>  <span class=o>......</span>
</span></span><span class=line><span class=cl>  <span class=c1>// å¯ä»¥ç›´æ¥ä»ä¼‘çœ çš„goroutineè·å–æ•°æ®</span>
</span></span><span class=line><span class=cl>  <span class=nf>send</span><span class=p>(</span><span class=nx>c</span><span class=p>,</span> <span class=nx>sg</span><span class=p>,</span> <span class=nx>cas</span><span class=p>.</span><span class=nx>elem</span><span class=p>,</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span> <span class=nf>selunlock</span><span class=p>(</span><span class=nx>scases</span><span class=p>,</span> <span class=nx>lockorder</span><span class=p>)</span> <span class=p>},</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nx>debugSelect</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s>&#34;syncsend: cas0=&#34;</span><span class=p>,</span> <span class=nx>cas0</span><span class=p>,</span> <span class=s>&#34; c=&#34;</span><span class=p>,</span> <span class=nx>c</span><span class=p>,</span> <span class=s>&#34;\n&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>goto</span> <span class=nx>retc</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>retc</span><span class=p>:</span>
</span></span><span class=line><span class=cl>  <span class=c1>// é€€å‡ºselectgo()å‡½æ•°</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nx>caseReleaseTime</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>blockevent</span><span class=p>(</span><span class=nx>caseReleaseTime</span><span class=o>-</span><span class=nx>t0</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>casi</span><span class=p>,</span> <span class=nx>recvOK</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>sclose</span><span class=p>:</span>
</span></span><span class=line><span class=cl>  <span class=c1>// å‘ä¸€ä¸ªå…³é—­çš„ channel å‘é€æ•°æ®å°±ä¼šç›´æ¥ panic é€ æˆç¨‹åºå´©æºƒï¼›</span>
</span></span><span class=line><span class=cl>  <span class=nf>selunlock</span><span class=p>(</span><span class=nx>scases</span><span class=p>,</span> <span class=nx>lockorder</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nb>panic</span><span class=p>(</span><span class=nf>plainError</span><span class=p>(</span><span class=s>&#34;send on closed channel&#34;</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div><p>æ€»ç»“ä¸€ä¸‹</p><p><code>selectgo</code>å‡½æ•°æ‰§è¡Œæ—¶ä¼šå…ˆæŒ‰ç…§æœ‰åºçš„åŠ é”é¡ºåºå¯¹æ‰€æœ‰çš„<code>channel</code>è¿›è¡ŒåŠ é”</p><p>ç„¶åæŒ‰ç…§ä¹±åºçš„è½®è¯¢é¡ºåºæ£€æŸ¥æ‰€æœ‰<code>channel</code>çš„ç­‰å¾…é˜Ÿåˆ—å’Œç¼“å†²åŒºï¼Œå‡å¦‚æ£€æŸ¥åˆ°æŸä¸ª<code>channel</code>æœ‰æ•°æ®å¯æ“ä½œï¼Œå°±ä¼šç›´æ¥æ‹·è´æ•°æ®è¿›å…¥ç›¸åº”çš„<code>case</code>åˆ†æ”¯</p><p>å¦‚æœæ‰€æœ‰çš„<code>channel</code>éƒ½ä¸å¯æ“ä½œï¼Œå°±æŠŠå½“å‰çš„åç¨‹æ·»åŠ åˆ°æ‰€æœ‰<code>channel</code>çš„<code>sendq</code>æˆ–<code>recvq</code>ä¸­</p><p>æ¥ç€è¯¥åç¨‹ä¼šæŒ‚èµ·ï¼Œå¹¶è§£é”æ‰€æœ‰çš„<code>channel</code></p><p>åŠ å…¥ç°åœ¨æŸä¸ª<code>channel</code>æœ‰æ•°æ®å¯æ“ä½œäº†ï¼Œå°±ä¼šå”¤é†’è¯¥åç¨‹è¿›å…¥<code>case</code>åˆ†æ”¯</p><p>å®Œæˆå¯¹åº”åˆ†æ”¯çš„æ“ä½œä¹‹åï¼Œä¼šå†æ¬¡æŒ‰ç…§åŠ é”é¡ºåºå¯¹æ‰€æœ‰<code>channel</code>è¿›è¡ŒåŠ é”ï¼Œç„¶åä»æ‰€æœ‰<code>sendq</code>æˆ–<code>recvq</code>ä¸­å°†è‡ªå·±ç§»é™¤</p><p>æœ€åå…¨éƒ¨è§£é”åè¿”å›</p><p><img loading=lazy src=/posts/golang/channel/007.png></p><h2 id=ç¼–è¯‘å™¨è¿˜å¯¹selectåšäº†å“ªäº›å¤„ç†>ç¼–è¯‘å™¨è¿˜å¯¹selectåšäº†å“ªäº›å¤„ç†<a hidden class=anchor aria-hidden=true href=#ç¼–è¯‘å™¨è¿˜å¯¹selectåšäº†å“ªäº›å¤„ç†>#</a></h2><p>è¿™é‡Œä¸»è¦è¿˜æƒ³æåˆ°çš„æ˜¯<code>src/cmd/compile/internal/walk/select.go</code>ä¸­çš„<code>walkSelectCases()</code></p><p>è¯¥å‡½æ•°æ˜¯å¯¹<code>select</code>ä¸åŒ<code>case</code>åˆ†æ”¯æ¡ä»¶çš„å¤„ç†ï¼Œä¸åŒçš„æƒ…å†µä¼šè°ƒç”¨ä¸åŒçš„è¿è¡Œæ—¶å‡½æ•°ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º</p><p><img loading=lazy src=/posts/golang/channel/008.png></p><p>å…·ä½“å…³äº<code>walkSelectCases()</code>çš„æºç å°±æš‚æ—¶ä¸åœ¨è¿™é‡Œå±•å¼€å•¦</p><blockquote><p>ä½œä¸ºä¸€åå¤§äºŒå°ç™½Gopherï¼Œæ–‡ç« å­˜åœ¨æœ‰ä»»ä½•é—®é¢˜éƒ½å¯ä»¥è”ç³»æˆ‘ï¼Œå½“ç„¶ä¹Ÿæ¬¢è¿ä¸æˆ‘äº¤æµæŠ€æœ¯ç›¸å…³çš„é—®é¢˜ï¼Œæ„Ÿè°¢ä½ çš„é˜…è¯»ğŸ¤—</p></blockquote></div><footer class=post-footer><ul class=post-tags><li><a href=https://whitea029.github.io/tags/go/>Go</a></li></ul><nav class=paginav><a class=next href=https://whitea029.github.io/posts/golang/interface/><span class=title>Next Â»</span><br><span>ç¡¬æ ¸â€”â€”ä½ çœŸçš„æå®šGolangæ¥å£äº†ä¹ˆ</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://whitea029.github.io/>Whitea's Blog</a></span> Â·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>